package pcadelegate

import (
	"crypto/x509"
	"encoding/pem"
	"errors"
	"testing"

	"github.com/linkerd/linkerd2/pkg/pcadelegate/test_helpers"
	log "github.com/sirupsen/logrus"
)

func TestFailedIssueCert(t *testing.T) {
	expectedError := errors.New("issueCertError")
	myClient := test_helpers.MockACMClient{
		IssueCertError: expectedError,
	}

	subject := ACMPCADelegate{
		acmClient: myClient,
		caARN:     "myARN",
	}

	realCsr := test_helpers.CreateCSR()
	_, err := subject.IssueEndEntityCrt(&realCsr)

	if err != expectedError {
		t.Fail()
	}
}

func TestParsingCertificateChainSingle(t *testing.T) {
	certChain := "-----BEGIN CERTIFICATE-----\nMIID6TCCAtOgAwIBAgIRAKfiZ1mtnUgxuim0oA096JEwCwYJKoZIhvcNAQENMIGM\nMQswCQYDVQQGEwJVUzETMBEGA1UECAwKV2FzaGluZ3RvbjEQMA4GA1UEBwwHU2Vh\ndHRsZTEiMCAGA1UECgwZU09OX09GX1RFU1RfUFJJVkFURV9UTUVTSDEOMAwGA1UE\nCwwFVE1FU0gxIjAgBgNVBAMMGVNPTl9PRl9URVNUX1BSSVZBVEVfVE1FU0gwHhcN\nMTkwNDAzMjAyMDMyWhcNMTkwNTAzMjEyMDMyWjBRMU8wTQYDVQQDE0ZsaW5rZXJk\nLWlkZW50aXR5LmxpbmtlcmQuc2VydmljZWFjY291bnQuaWRlbnRpdHkubGlua2Vy\nZC5jbHVzdGVyLmxvY2FsMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEBm/zJk9C\n8Xl6v7B1pMWz7JS8MyUIz2+oO/+AZ4RFlxLQPVYU0ddo7n0ctcKkVCAluf2cgKPr\nS70GUaQsmPxD8qOCAU0wggFJMFEGA1UdEQRKMEiCRmxpbmtlcmQtaWRlbnRpdHku\nbGlua2VyZC5zZXJ2aWNlYWNjb3VudC5pZGVudGl0eS5saW5rZXJkLmNsdXN0ZXIu\nbG9jYWwwCQYDVR0TBAIwADAfBgNVHSMEGDAWgBSNbCVHbJ+crMCeYY6+1QS0XXjn\nJzAdBgNVHQ4EFgQUhyd2VMGzdDnAfzeSAk6fQntnMUkwDgYDVR0PAQH/BAQDAgWg\nMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjB6BgNVHR8EczBxMG+gbaBr\nhmlodHRwOi8vY2FwaW5vLXRlc3QtcHJpdmF0ZS1jYS1jcmwuczMudXMtd2VzdC0y\nLmFtYXpvbmF3cy5jb20vY3JsLzQ2ZThmY2QwLWQ2MTUtNDJhMS05ODk0LTRkYzQ1\nOTQ0ZDU1NC5jcmwwCwYJKoZIhvcNAQENA4IBAQCdgRVHovRfdcPnu0V5EojPKRT6\nzadbJtX1/nQZ476WVDMcTjN+18n4YRZv/yEgYDAH/R9kgAdBmoyDU5meA177GSjP\ndTcilLk+PnZEASYxqnYaWzDi8zhP4S3AhYohkUFVrsTVhXn5CbqcU0ORB9cHKaRM\nJ4zdyi3qYWaVUfShbDHTI9jJtNjDzOMP/FK6JFn1f/xjB5oJIULXmKa873r0Pnnl\nFIXQwSeEQ2TLpEXeD9209aPl0ubciBzcHyHOojRoLPQiCRRVIwoorITAfNKA+EFl\ngc594av/mRJys9cKWyClqKqE6857Aqk/ULsvdtw57IGIEMk34iWNwOqvtXDM\n-----END CERTIFICATE-----\n"

	_, extractError := extractTrustChain(certChain)
	if extractError != nil {
		t.Fail()
	}
}

func TestParsingCertificateChainMultiple(t *testing.T) {
	certChainWithNoNewline := "-----BEGIN CERTIFICATE-----\nMIIDujCCAqKgAwIBAgICEAUwDQYJKoZIhvcNAQEFBQAwcDELMAkGA1UEBhMCVVMx\nCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQKDAVUTUVTSDEO\nMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5vcmRzdHJvbS5j\nb20wHhcNMTkwMzI5MjE0MDAwWhcNMjAwMzI4MjE0MDAwWjCBjDELMAkGA1UEBhMC\nVVMxEzARBgNVBAgMCldhc2hpbmd0b24xEDAOBgNVBAcMB1NlYXR0bGUxIjAgBgNV\nBAoMGVNPTl9PRl9URVNUX1BSSVZBVEVfVE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIw\nIAYDVQQDDBlTT05fT0ZfVEVTVF9QUklWQVRFX1RNRVNIMIIBIjANBgkqhkiG9w0B\nAQEFAAOCAQ8AMIIBCgKCAQEAxm0KSQwtnboTF3824PzcwPDakkzD9SuXUS4YxXgl\nJ8A6J3FQ/TI/5sbYl9LJsKCb9UEKz4Ao4X2ixWUACe5B9UO1YrWTpKnZ/mlNfTRC\nO6g+EwusTLcRqxepmYQq3Xu0r25EyT3l1vsCXOBI/BlfgRF6lXndwV6Mtqs+t7Yk\nKfFtzadcNc2hz8hm72L1P6d8LGxOTjavI06+tYz2iCm14pld7K5UzjdJVgHD2Aia\n9gL0pzoLSmdDjqKehtYWSx1xw4v6patZaaRxjbqA3zDzuEzsy1xmUHF44wlznOVL\nGseBmYA3DqW1YOGB//asg1ZRa0hEH7FIV8bktj9qTg7SfQIDAQABo0EwPzAfBgNV\nHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8EBTADAQH/MAsG\nA1UdDwQEAwIE8DANBgkqhkiG9w0BAQUFAAOCAQEAcrf3OLA+ug+6HkWejZldZPaZ\nIas6MNc6S3FKodRK6miU8MbMfF7PTYfgsP5CiBxCjjg3/0qfXlNcq5zQEOecdWkx\nqAG3y9ZRvTCfLW+T1tU0/5hXcHQzqI3ZmyfTe3dzdTmU+LG6vpcNEwrMed3gQ9Ld\nmwN7OVQPVdTh+0NezxOA5hKzgr4QQ0JErolBPsje5V81l9IfK+6VRZRToC+VQ3YP\nNUy64Z3lRl8ugJTAGfyZZdqkq6Qr7HJKI4rzd71MpDA9x/wwShiIgLnsJfF47v/S\nsZvz5MbgMNeNnKt/PVzf8EIQ9c5x0v/66R+Fu/TX3nXFYjbojqFiA6FHS1rfmQ==\n-----END CERTIFICATE----------BEGIN CERTIFICATE-----\nMIIDxjCCAq6gAwIBAgIJAO6DSG+Jvt0vMA0GCSqGSIb3DQEBDAUAMHAxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEOMAwGA1UECgwF\nVE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIwIAYJKoZIhvcNAQkBFhNUTUVTSEBub3Jk\nc3Ryb20uY29tMB4XDTE5MDMyODIxMTM0MFoXDTE5MDQyNzIxMTM0MFowcDELMAkG\nA1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQK\nDAVUTUVTSDEOMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5v\ncmRzdHJvbS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCeP6ez\n6jFDvmiK54pHhdH9/vwgteQ2SaPCCzH3+LPftE+98r9cYH7q+/AoHHaDUlK3CBRz\n63QrbKFNJfwY5LbEDKma+YR2zSMJLveDlW89hnuwVoCjdfThNqZOoqVOx1QFYBBv\nZ6lvtce2Oc5tmRwOfXudJTragqkMJme0Mn6CCy98R3VGysh7jnPJjb0JD2PygMMx\nKhGuzoM7Ib2Vf6vzOt4oqHFoHkCo1sgLvi7ojCo11ynB0pvequ6HElxgqEnoBUA7\npIhsqe4/gJyC62xjBKON48G/7Ut0xgXMmN0Ir+7nfBiGC8iBVy6smSv+qQ3dAxGx\nUbAUwTKNge9p+1Y3AgMBAAGjYzBhMB0GA1UdDgQWBBSYj5Tn7VrJSXj02YbqGnUv\nypxCGjAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8E\nBTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG9w0BAQwFAAOCAQEAcwQf730e\n6OhPRJ7yU5WVfARck3OgG1kWz4O3F0ZT9SC+85Q920jS3oBfaV2G4cTAsLgvk0rM\n62ghhN7BL/a06+iRkD7xO7w9ftcOReUqlaJ2SQi1L3eL6Cn6pu3mHwWyh3DqYdkW\n2y9SYGTWpmkIW/tG2k+/atnHeC7iEfxlO7Xq1aoAVBGJStR9JFQlETn52nRaG03r\ntMyEU+MrZhJDQR9gIFL/lBC/uLAkkNYqN7E4tbzc4n1rr1OuiTq3XeSdSGrxHkcp\nizHKiX1uPiG0iv5fI43XyTwHHlrfesYhxmFOv/I0HdsuFjQUHyPEq9pB0GsqKsoj\nL/EIQ1Caao5a3g==\n-----END CERTIFICATE-----"
	_, extractNoNewlineError := extractTrustChain(certChainWithNoNewline)
	if extractNoNewlineError != nil {
		t.Fail()
	}
	certChainAlreadyHasNewline := "-----BEGIN CERTIFICATE-----\nMIIDujCCAqKgAwIBAgICEAUwDQYJKoZIhvcNAQEFBQAwcDELMAkGA1UEBhMCVVMx\nCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQKDAVUTUVTSDEO\nMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5vcmRzdHJvbS5j\nb20wHhcNMTkwMzI5MjE0MDAwWhcNMjAwMzI4MjE0MDAwWjCBjDELMAkGA1UEBhMC\nVVMxEzARBgNVBAgMCldhc2hpbmd0b24xEDAOBgNVBAcMB1NlYXR0bGUxIjAgBgNV\nBAoMGVNPTl9PRl9URVNUX1BSSVZBVEVfVE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIw\nIAYDVQQDDBlTT05fT0ZfVEVTVF9QUklWQVRFX1RNRVNIMIIBIjANBgkqhkiG9w0B\nAQEFAAOCAQ8AMIIBCgKCAQEAxm0KSQwtnboTF3824PzcwPDakkzD9SuXUS4YxXgl\nJ8A6J3FQ/TI/5sbYl9LJsKCb9UEKz4Ao4X2ixWUACe5B9UO1YrWTpKnZ/mlNfTRC\nO6g+EwusTLcRqxepmYQq3Xu0r25EyT3l1vsCXOBI/BlfgRF6lXndwV6Mtqs+t7Yk\nKfFtzadcNc2hz8hm72L1P6d8LGxOTjavI06+tYz2iCm14pld7K5UzjdJVgHD2Aia\n9gL0pzoLSmdDjqKehtYWSx1xw4v6patZaaRxjbqA3zDzuEzsy1xmUHF44wlznOVL\nGseBmYA3DqW1YOGB//asg1ZRa0hEH7FIV8bktj9qTg7SfQIDAQABo0EwPzAfBgNV\nHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8EBTADAQH/MAsG\nA1UdDwQEAwIE8DANBgkqhkiG9w0BAQUFAAOCAQEAcrf3OLA+ug+6HkWejZldZPaZ\nIas6MNc6S3FKodRK6miU8MbMfF7PTYfgsP5CiBxCjjg3/0qfXlNcq5zQEOecdWkx\nqAG3y9ZRvTCfLW+T1tU0/5hXcHQzqI3ZmyfTe3dzdTmU+LG6vpcNEwrMed3gQ9Ld\nmwN7OVQPVdTh+0NezxOA5hKzgr4QQ0JErolBPsje5V81l9IfK+6VRZRToC+VQ3YP\nNUy64Z3lRl8ugJTAGfyZZdqkq6Qr7HJKI4rzd71MpDA9x/wwShiIgLnsJfF47v/S\nsZvz5MbgMNeNnKt/PVzf8EIQ9c5x0v/66R+Fu/TX3nXFYjbojqFiA6FHS1rfmQ==\n-----END CERTIFICATE-----\n-----BEGIN CERTIFICATE-----\nMIIDxjCCAq6gAwIBAgIJAO6DSG+Jvt0vMA0GCSqGSIb3DQEBDAUAMHAxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEOMAwGA1UECgwF\nVE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIwIAYJKoZIhvcNAQkBFhNUTUVTSEBub3Jk\nc3Ryb20uY29tMB4XDTE5MDMyODIxMTM0MFoXDTE5MDQyNzIxMTM0MFowcDELMAkG\nA1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQK\nDAVUTUVTSDEOMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5v\ncmRzdHJvbS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCeP6ez\n6jFDvmiK54pHhdH9/vwgteQ2SaPCCzH3+LPftE+98r9cYH7q+/AoHHaDUlK3CBRz\n63QrbKFNJfwY5LbEDKma+YR2zSMJLveDlW89hnuwVoCjdfThNqZOoqVOx1QFYBBv\nZ6lvtce2Oc5tmRwOfXudJTragqkMJme0Mn6CCy98R3VGysh7jnPJjb0JD2PygMMx\nKhGuzoM7Ib2Vf6vzOt4oqHFoHkCo1sgLvi7ojCo11ynB0pvequ6HElxgqEnoBUA7\npIhsqe4/gJyC62xjBKON48G/7Ut0xgXMmN0Ir+7nfBiGC8iBVy6smSv+qQ3dAxGx\nUbAUwTKNge9p+1Y3AgMBAAGjYzBhMB0GA1UdDgQWBBSYj5Tn7VrJSXj02YbqGnUv\nypxCGjAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8E\nBTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG9w0BAQwFAAOCAQEAcwQf730e\n6OhPRJ7yU5WVfARck3OgG1kWz4O3F0ZT9SC+85Q920jS3oBfaV2G4cTAsLgvk0rM\n62ghhN7BL/a06+iRkD7xO7w9ftcOReUqlaJ2SQi1L3eL6Cn6pu3mHwWyh3DqYdkW\n2y9SYGTWpmkIW/tG2k+/atnHeC7iEfxlO7Xq1aoAVBGJStR9JFQlETn52nRaG03r\ntMyEU+MrZhJDQR9gIFL/lBC/uLAkkNYqN7E4tbzc4n1rr1OuiTq3XeSdSGrxHkcp\nizHKiX1uPiG0iv5fI43XyTwHHlrfesYhxmFOv/I0HdsuFjQUHyPEq9pB0GsqKsoj\nL/EIQ1Caao5a3g==\n-----END CERTIFICATE-----"
	magical, extractAlreadyHasNewlineError := extractTrustChain(certChainAlreadyHasNewline)
	if extractAlreadyHasNewlineError != nil {
		t.Fail()
	}
	log.Error(magical)
}

func TestVerify(t *testing.T) {

	refroots := x509.NewCertPool()
	refinterm := x509.NewCertPool()

	const refrootCert = "-----BEGIN CERTIFICATE-----\nMIIDxjCCAq6gAwIBAgIJAO6DSG+Jvt0vMA0GCSqGSIb3DQEBDAUAMHAxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEOMAwGA1UECgwF\nVE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIwIAYJKoZIhvcNAQkBFhNUTUVTSEBub3Jk\nc3Ryb20uY29tMB4XDTE5MDMyODIxMTM0MFoXDTE5MDQyNzIxMTM0MFowcDELMAkG\nA1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQK\nDAVUTUVTSDEOMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5v\ncmRzdHJvbS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCeP6ez\n6jFDvmiK54pHhdH9/vwgteQ2SaPCCzH3+LPftE+98r9cYH7q+/AoHHaDUlK3CBRz\n63QrbKFNJfwY5LbEDKma+YR2zSMJLveDlW89hnuwVoCjdfThNqZOoqVOx1QFYBBv\nZ6lvtce2Oc5tmRwOfXudJTragqkMJme0Mn6CCy98R3VGysh7jnPJjb0JD2PygMMx\nKhGuzoM7Ib2Vf6vzOt4oqHFoHkCo1sgLvi7ojCo11ynB0pvequ6HElxgqEnoBUA7\npIhsqe4/gJyC62xjBKON48G/7Ut0xgXMmN0Ir+7nfBiGC8iBVy6smSv+qQ3dAxGx\nUbAUwTKNge9p+1Y3AgMBAAGjYzBhMB0GA1UdDgQWBBSYj5Tn7VrJSXj02YbqGnUv\nypxCGjAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8E\nBTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG9w0BAQwFAAOCAQEAcwQf730e\n6OhPRJ7yU5WVfARck3OgG1kWz4O3F0ZT9SC+85Q920jS3oBfaV2G4cTAsLgvk0rM\n62ghhN7BL/a06+iRkD7xO7w9ftcOReUqlaJ2SQi1L3eL6Cn6pu3mHwWyh3DqYdkW\n2y9SYGTWpmkIW/tG2k+/atnHeC7iEfxlO7Xq1aoAVBGJStR9JFQlETn52nRaG03r\ntMyEU+MrZhJDQR9gIFL/lBC/uLAkkNYqN7E4tbzc4n1rr1OuiTq3XeSdSGrxHkcp\nizHKiX1uPiG0iv5fI43XyTwHHlrfesYhxmFOv/I0HdsuFjQUHyPEq9pB0GsqKsoj\nL/EIQ1Caao5a3g==\n-----END CERTIFICATE-----"
	const refintermediateCert = "-----BEGIN CERTIFICATE-----\nMIIDeDCCAmCgAwIBAgICEAkwDQYJKoZIhvcNAQELBQAwcDELMAkGA1UEBhMCVVMx\nCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQKDAVUTUVTSDEO\nMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5vcmRzdHJvbS5j\nb20wHhcNMTkwNDEwMjAyMzIyWhcNMjAwNDA5MjAyMzIyWjBLMRcwFQYDVQQKDA5Q\nQ0FfVEVTVF9UTUVTSDEXMBUGA1UECwwOUENBX1RFU1RfVE1FU0gxFzAVBgNVBAMM\nDlBDQV9URVNUX1RNRVNIMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA\np5J0qkEsHWAQwV4G4LCj+qRp2bsYq/O3zq+yaFfF8VJJ5va61vWfRob36/vCosgd\ntTrhUSXtRxNMyu/MYPL2vLV14/clXKhS3blldACYeM6VSpQhHsHsRKNm3EIFTZb5\ne8i9ZPjha2cZ09u3mtD5SymJPyPHbuL0TG7Hh1/5RjyOKM23w/nlDlsSepAsqUSb\nsEpXXx88DtdUpc5AgH4FJOn+ZrC3nSlbS/BJxs01krZaZkcDIs2A2gBlMlNC6Szj\nNLXT/qH3e4GuJ9DsiwRCrQjImQTJOow/15J+iLKEXOW6DkKS08Q35YXI1pKUZfDz\nVO7E/aN48Oo3NaV5frYNaQIDAQABo0EwPzAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj0\n2YbqGnUvypxCGjAPBgNVHRMBAf8EBTADAQH/MAsGA1UdDwQEAwIC9DANBgkqhkiG\n9w0BAQsFAAOCAQEAV9mqzO/n04GFPleSvTnS8Y1z4DHryWGhPeUpDLJo5M/heWJq\nuHdHo1kbddNrFt6jYsxroNtSIPf5ToEzk+Jh+RULrm6EFnQlnaZWL9tR/6n+TRyT\nLoT9L06gq3JBwitHDAe0U0jxTOT5RbqDh0/y9RaWeHEkZThAHkDWYcTkLdRIlP8U\n8igu5HeqaPWBi8raStey6v4FFWWcZfrfRXwIUFZGyVfgmnK9XkvPaPpOLm4QIMt1\nnt449NMdzRlrsG7digb7oCOSK7K9B/YO5K7SjMvBKJwtiexmxUNPABu0p7cAwy6K\n0iPy6sY511GT7GV2ubKp5kFbRf6NNjHuEZnARA==\n-----END CERTIFICATE-----"
	const refendCert = "-----BEGIN CERTIFICATE-----\nMIIDpzCCApGgAwIBAgIRAMI86n7ZstxnF9GsvEI6V1owCwYJKoZIhvcNAQENMEsx\nFzAVBgNVBAoMDlBDQV9URVNUX1RNRVNIMRcwFQYDVQQLDA5QQ0FfVEVTVF9UTUVT\nSDEXMBUGA1UEAwwOUENBX1RFU1RfVE1FU0gwHhcNMTkwNDE2MjEyMjUyWhcNMTkw\nNTE2MjIyMjUyWjBRMU8wTQYDVQQDE0ZsaW5rZXJkLWlkZW50aXR5LmxpbmtlcmQu\nc2VydmljZWFjY291bnQuaWRlbnRpdHkubGlua2VyZC5jbHVzdGVyLmxvY2FsMFkw\nEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEyeLBKJpnfLvR6L4FVcDkMCnSn4OZzUeY\nKW5WFb+kI97/YICFr2ZLkaGO/0iblwea5VA+HndOhei8yYUr/HgA0qOCAU0wggFJ\nMFEGA1UdEQRKMEiCRmxpbmtlcmQtaWRlbnRpdHkubGlua2VyZC5zZXJ2aWNlYWNj\nb3VudC5pZGVudGl0eS5saW5rZXJkLmNsdXN0ZXIubG9jYWwwCQYDVR0TBAIwADAf\nBgNVHSMEGDAWgBT6eMuyRej+m9GHVrZHtJJcvadSwzAdBgNVHQ4EFgQUYOplA6IK\ntL1T0FkRUqaMxUHXc9wwDgYDVR0PAQH/BAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUF\nBwMBBggrBgEFBQcDAjB6BgNVHR8EczBxMG+gbaBrhmlodHRwOi8vY2FwaW5vLXRl\nc3QtcHJpdmF0ZS1jYS1jcmwuczMudXMtd2VzdC0yLmFtYXpvbmF3cy5jb20vY3Js\nLzhiMzA4YmQ4LWY1MDgtNDE2ZS05Nzc1LTViMzFmMTk1ZTIxYS5jcmwwCwYJKoZI\nhvcNAQENA4IBAQAIEq8Igp8G+SIfcI444LZRT1PgkxqW5Gdvt1krktuFgDz3xBfc\nAVv1Oi+vS8UWdczbGF8/xUCN2MYj2MNVvEVRQFtWgzAH502dBoewEg9Ki410rm1V\nZaIVOSxOIkRlAmqJSMOSd8uBDKtoCa2A9lRHLjFz2xtVpASuWKYiLNDHfhYEzkop\nJ+ZuoH0kar1GQmR8NedJUekxAX9cBZjm68qsoXt8kqh2zo21VJOmDfwmVYo97fnT\nDm7ubCvvuB6kGV+D4D3G37vm+q2+3C/12/JcwyPv+hctVnn1Ed1k/Ut8CUBwjK6V\nIWrPm8ENW+wZ3uoFBgWx94xNDmGp9upPHmYq\n-----END CERTIFICATE-----\n"

	//okroot := roots.AppendCertsFromPEM([]byte(chopped[1]))
	refokroot := refroots.AppendCertsFromPEM([]byte(refrootCert))
	if !refokroot {
		log.Error("REFERENCE failed to parse rooty certificate")
		t.Fail()
	}
	//okinterm := interm.AppendCertsFromPEM([]byte(chopped[0]))
	refokinterm := refinterm.AppendCertsFromPEM([]byte(refintermediateCert))
	if !refokinterm {
		log.Error("REFERENCE failed to parse interm certificate")
		t.Fail()
	}

	refopts := x509.VerifyOptions{
		DNSName:       "linkerd-identity.linkerd.serviceaccount.identity.linkerd.cluster.local",
		Roots:         refroots,
		Intermediates: refinterm,
	}

	refblock, _ := pem.Decode([]byte(refendCert))
	if refblock == nil {
		panic("REFERENCE failed to parse certificate PEM")
		t.Fail()
	}
	refcert, referr := x509.ParseCertificate(refblock.Bytes)
	if referr != nil {
		panic("REFERENCE failed to parse certificate: " + referr.Error())
		t.Fail()
	}

	if _, refverifyErr := refcert.Verify(refopts); refverifyErr != nil {
		log.Errorf("REFERENCE failed to verify certificate " + refverifyErr.Error())
		t.Fail()
	}

	roots := x509.NewCertPool()
	interm := x509.NewCertPool()

	const rootCert = "-----BEGIN CERTIFICATE-----\nMIIDxjCCAq6gAwIBAgIJAO6DSG+Jvt0vMA0GCSqGSIb3DQEBDAUAMHAxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEOMAwGA1UECgwF\nVE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIwIAYJKoZIhvcNAQkBFhNUTUVTSEBub3Jk\nc3Ryb20uY29tMB4XDTE5MDMyODIxMTM0MFoXDTE5MDQyNzIxMTM0MFowcDELMAkG\nA1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQK\nDAVUTUVTSDEOMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5v\ncmRzdHJvbS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCeP6ez\n6jFDvmiK54pHhdH9/vwgteQ2SaPCCzH3+LPftE+98r9cYH7q+/AoHHaDUlK3CBRz\n63QrbKFNJfwY5LbEDKma+YR2zSMJLveDlW89hnuwVoCjdfThNqZOoqVOx1QFYBBv\nZ6lvtce2Oc5tmRwOfXudJTragqkMJme0Mn6CCy98R3VGysh7jnPJjb0JD2PygMMx\nKhGuzoM7Ib2Vf6vzOt4oqHFoHkCo1sgLvi7ojCo11ynB0pvequ6HElxgqEnoBUA7\npIhsqe4/gJyC62xjBKON48G/7Ut0xgXMmN0Ir+7nfBiGC8iBVy6smSv+qQ3dAxGx\nUbAUwTKNge9p+1Y3AgMBAAGjYzBhMB0GA1UdDgQWBBSYj5Tn7VrJSXj02YbqGnUv\nypxCGjAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8E\nBTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG9w0BAQwFAAOCAQEAcwQf730e\n6OhPRJ7yU5WVfARck3OgG1kWz4O3F0ZT9SC+85Q920jS3oBfaV2G4cTAsLgvk0rM\n62ghhN7BL/a06+iRkD7xO7w9ftcOReUqlaJ2SQi1L3eL6Cn6pu3mHwWyh3DqYdkW\n2y9SYGTWpmkIW/tG2k+/atnHeC7iEfxlO7Xq1aoAVBGJStR9JFQlETn52nRaG03r\ntMyEU+MrZhJDQR9gIFL/lBC/uLAkkNYqN7E4tbzc4n1rr1OuiTq3XeSdSGrxHkcp\nizHKiX1uPiG0iv5fI43XyTwHHlrfesYhxmFOv/I0HdsuFjQUHyPEq9pB0GsqKsoj\nL/EIQ1Caao5a3g==\n-----END CERTIFICATE-----"
	const intermediateCert = "-----BEGIN CERTIFICATE-----\nMIIDeDCCAmCgAwIBAgICEAkwDQYJKoZIhvcNAQELBQAwcDELMAkGA1UEBhMCVVMx\nCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQKDAVUTUVTSDEO\nMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5vcmRzdHJvbS5j\nb20wHhcNMTkwNDEwMjAyMzIyWhcNMjAwNDA5MjAyMzIyWjBLMRcwFQYDVQQKDA5Q\nQ0FfVEVTVF9UTUVTSDEXMBUGA1UECwwOUENBX1RFU1RfVE1FU0gxFzAVBgNVBAMM\nDlBDQV9URVNUX1RNRVNIMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA\np5J0qkEsHWAQwV4G4LCj+qRp2bsYq/O3zq+yaFfF8VJJ5va61vWfRob36/vCosgd\ntTrhUSXtRxNMyu/MYPL2vLV14/clXKhS3blldACYeM6VSpQhHsHsRKNm3EIFTZb5\ne8i9ZPjha2cZ09u3mtD5SymJPyPHbuL0TG7Hh1/5RjyOKM23w/nlDlsSepAsqUSb\nsEpXXx88DtdUpc5AgH4FJOn+ZrC3nSlbS/BJxs01krZaZkcDIs2A2gBlMlNC6Szj\nNLXT/qH3e4GuJ9DsiwRCrQjImQTJOow/15J+iLKEXOW6DkKS08Q35YXI1pKUZfDz\nVO7E/aN48Oo3NaV5frYNaQIDAQABo0EwPzAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj0\n2YbqGnUvypxCGjAPBgNVHRMBAf8EBTADAQH/MAsGA1UdDwQEAwIC9DANBgkqhkiG\n9w0BAQsFAAOCAQEAV9mqzO/n04GFPleSvTnS8Y1z4DHryWGhPeUpDLJo5M/heWJq\nuHdHo1kbddNrFt6jYsxroNtSIPf5ToEzk+Jh+RULrm6EFnQlnaZWL9tR/6n+TRyT\nLoT9L06gq3JBwitHDAe0U0jxTOT5RbqDh0/y9RaWeHEkZThAHkDWYcTkLdRIlP8U\n8igu5HeqaPWBi8raStey6v4FFWWcZfrfRXwIUFZGyVfgmnK9XkvPaPpOLm4QIMt1\nnt449NMdzRlrsG7digb7oCOSK7K9B/YO5K7SjMvBKJwtiexmxUNPABu0p7cAwy6K\n0iPy6sY511GT7GV2ubKp5kFbRf6NNjHuEZnARA==\n-----END CERTIFICATE-----"
	const endCert = "-----BEGIN CERTIFICATE-----\nMIIDpzCCApGgAwIBAgIRAMI86n7ZstxnF9GsvEI6V1owCwYJKoZIhvcNAQENMEsx\nFzAVBgNVBAoMDlBDQV9URVNUX1RNRVNIMRcwFQYDVQQLDA5QQ0FfVEVTVF9UTUVT\nSDEXMBUGA1UEAwwOUENBX1RFU1RfVE1FU0gwHhcNMTkwNDE2MjEyMjUyWhcNMTkw\nNTE2MjIyMjUyWjBRMU8wTQYDVQQDE0ZsaW5rZXJkLWlkZW50aXR5LmxpbmtlcmQu\nc2VydmljZWFjY291bnQuaWRlbnRpdHkubGlua2VyZC5jbHVzdGVyLmxvY2FsMFkw\nEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEyeLBKJpnfLvR6L4FVcDkMCnSn4OZzUeY\nKW5WFb+kI97/YICFr2ZLkaGO/0iblwea5VA+HndOhei8yYUr/HgA0qOCAU0wggFJ\nMFEGA1UdEQRKMEiCRmxpbmtlcmQtaWRlbnRpdHkubGlua2VyZC5zZXJ2aWNlYWNj\nb3VudC5pZGVudGl0eS5saW5rZXJkLmNsdXN0ZXIubG9jYWwwCQYDVR0TBAIwADAf\nBgNVHSMEGDAWgBT6eMuyRej+m9GHVrZHtJJcvadSwzAdBgNVHQ4EFgQUYOplA6IK\ntL1T0FkRUqaMxUHXc9wwDgYDVR0PAQH/BAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUF\nBwMBBggrBgEFBQcDAjB6BgNVHR8EczBxMG+gbaBrhmlodHRwOi8vY2FwaW5vLXRl\nc3QtcHJpdmF0ZS1jYS1jcmwuczMudXMtd2VzdC0yLmFtYXpvbmF3cy5jb20vY3Js\nLzhiMzA4YmQ4LWY1MDgtNDE2ZS05Nzc1LTViMzFmMTk1ZTIxYS5jcmwwCwYJKoZI\nhvcNAQENA4IBAQAIEq8Igp8G+SIfcI444LZRT1PgkxqW5Gdvt1krktuFgDz3xBfc\nAVv1Oi+vS8UWdczbGF8/xUCN2MYj2MNVvEVRQFtWgzAH502dBoewEg9Ki410rm1V\nZaIVOSxOIkRlAmqJSMOSd8uBDKtoCa2A9lRHLjFz2xtVpASuWKYiLNDHfhYEzkop\nJ+ZuoH0kar1GQmR8NedJUekxAX9cBZjm68qsoXt8kqh2zo21VJOmDfwmVYo97fnT\nDm7ubCvvuB6kGV+D4D3G37vm+q2+3C/12/JcwyPv+hctVnn1Ed1k/Ut8CUBwjK6V\nIWrPm8ENW+wZ3uoFBgWx94xNDmGp9upPHmYq\n-----END CERTIFICATE-----\n"

	okroot := roots.AppendCertsFromPEM([]byte(rootCert))
	if !okroot {
		log.Error("failed to parse rooty certificate")
	}
	okinterm := interm.AppendCertsFromPEM([]byte(intermediateCert))
	if !okinterm {
		log.Error("failed to parse interm certificate")
	}

	opts := x509.VerifyOptions{
		DNSName:       "linkerd-identity.linkerd.serviceaccount.identity.linkerd.cluster.local",
		Roots:         roots,
		Intermediates: interm,
	}

	block, _ := pem.Decode([]byte(endCert))
	if block == nil {
		panic("failed to parse certificate PEM")
	}
	cert, err := x509.ParseCertificate(block.Bytes)
	if err != nil {
		panic("failed to parse certificate: " + err.Error())
	}

	if _, verifyErr := cert.Verify(opts); verifyErr != nil {
		log.Errorf("failed to verify certificate   0=root 1=intermediate: " + err.Error())
		t.Fail()
	}
}
