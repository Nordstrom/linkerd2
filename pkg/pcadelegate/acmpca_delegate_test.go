package pcadelegate

import (
	"errors"
	"testing"

	"github.com/linkerd/linkerd2/pkg/pcadelegate/test_helpers"
)

func TestFailedIssueCert(t *testing.T) {
	expectedError := errors.New("issueCertError")
	myClient := test_helpers.MockACMClient{
		IssueCertError: expectedError,
	}

	subject := ACMPCADelegate{
		acmClient: myClient,
		caARN:     "myARN",
	}

	realCsr := test_helpers.CreateCSR()
	_, err := subject.IssueEndEntityCrt(&realCsr)

	if err != expectedError {
		t.Fail()
	}
}

func TestParsingCertificateChainSingle(t *testing.T) {
	certChain := "-----BEGIN CERTIFICATE-----\nMIID6TCCAtOgAwIBAgIRAKfiZ1mtnUgxuim0oA096JEwCwYJKoZIhvcNAQENMIGM\nMQswCQYDVQQGEwJVUzETMBEGA1UECAwKV2FzaGluZ3RvbjEQMA4GA1UEBwwHU2Vh\ndHRsZTEiMCAGA1UECgwZU09OX09GX1RFU1RfUFJJVkFURV9UTUVTSDEOMAwGA1UE\nCwwFVE1FU0gxIjAgBgNVBAMMGVNPTl9PRl9URVNUX1BSSVZBVEVfVE1FU0gwHhcN\nMTkwNDAzMjAyMDMyWhcNMTkwNTAzMjEyMDMyWjBRMU8wTQYDVQQDE0ZsaW5rZXJk\nLWlkZW50aXR5LmxpbmtlcmQuc2VydmljZWFjY291bnQuaWRlbnRpdHkubGlua2Vy\nZC5jbHVzdGVyLmxvY2FsMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEBm/zJk9C\n8Xl6v7B1pMWz7JS8MyUIz2+oO/+AZ4RFlxLQPVYU0ddo7n0ctcKkVCAluf2cgKPr\nS70GUaQsmPxD8qOCAU0wggFJMFEGA1UdEQRKMEiCRmxpbmtlcmQtaWRlbnRpdHku\nbGlua2VyZC5zZXJ2aWNlYWNjb3VudC5pZGVudGl0eS5saW5rZXJkLmNsdXN0ZXIu\nbG9jYWwwCQYDVR0TBAIwADAfBgNVHSMEGDAWgBSNbCVHbJ+crMCeYY6+1QS0XXjn\nJzAdBgNVHQ4EFgQUhyd2VMGzdDnAfzeSAk6fQntnMUkwDgYDVR0PAQH/BAQDAgWg\nMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjB6BgNVHR8EczBxMG+gbaBr\nhmlodHRwOi8vY2FwaW5vLXRlc3QtcHJpdmF0ZS1jYS1jcmwuczMudXMtd2VzdC0y\nLmFtYXpvbmF3cy5jb20vY3JsLzQ2ZThmY2QwLWQ2MTUtNDJhMS05ODk0LTRkYzQ1\nOTQ0ZDU1NC5jcmwwCwYJKoZIhvcNAQENA4IBAQCdgRVHovRfdcPnu0V5EojPKRT6\nzadbJtX1/nQZ476WVDMcTjN+18n4YRZv/yEgYDAH/R9kgAdBmoyDU5meA177GSjP\ndTcilLk+PnZEASYxqnYaWzDi8zhP4S3AhYohkUFVrsTVhXn5CbqcU0ORB9cHKaRM\nJ4zdyi3qYWaVUfShbDHTI9jJtNjDzOMP/FK6JFn1f/xjB5oJIULXmKa873r0Pnnl\nFIXQwSeEQ2TLpEXeD9209aPl0ubciBzcHyHOojRoLPQiCRRVIwoorITAfNKA+EFl\ngc594av/mRJys9cKWyClqKqE6857Aqk/ULsvdtw57IGIEMk34iWNwOqvtXDM\n-----END CERTIFICATE-----\n"

	_, extractError := ExtractTrustChain(certChain)

	if extractError != nil {
		t.Fail()
	}
}

func TestParsingCertificateChainMultiple(t *testing.T) {
	certChainWithNoNewline := "-----BEGIN CERTIFICATE-----\nMIIDujCCAqKgAwIBAgICEAUwDQYJKoZIhvcNAQEFBQAwcDELMAkGA1UEBhMCVVMx\nCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQKDAVUTUVTSDEO\nMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5vcmRzdHJvbS5j\nb20wHhcNMTkwMzI5MjE0MDAwWhcNMjAwMzI4MjE0MDAwWjCBjDELMAkGA1UEBhMC\nVVMxEzARBgNVBAgMCldhc2hpbmd0b24xEDAOBgNVBAcMB1NlYXR0bGUxIjAgBgNV\nBAoMGVNPTl9PRl9URVNUX1BSSVZBVEVfVE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIw\nIAYDVQQDDBlTT05fT0ZfVEVTVF9QUklWQVRFX1RNRVNIMIIBIjANBgkqhkiG9w0B\nAQEFAAOCAQ8AMIIBCgKCAQEAxm0KSQwtnboTF3824PzcwPDakkzD9SuXUS4YxXgl\nJ8A6J3FQ/TI/5sbYl9LJsKCb9UEKz4Ao4X2ixWUACe5B9UO1YrWTpKnZ/mlNfTRC\nO6g+EwusTLcRqxepmYQq3Xu0r25EyT3l1vsCXOBI/BlfgRF6lXndwV6Mtqs+t7Yk\nKfFtzadcNc2hz8hm72L1P6d8LGxOTjavI06+tYz2iCm14pld7K5UzjdJVgHD2Aia\n9gL0pzoLSmdDjqKehtYWSx1xw4v6patZaaRxjbqA3zDzuEzsy1xmUHF44wlznOVL\nGseBmYA3DqW1YOGB//asg1ZRa0hEH7FIV8bktj9qTg7SfQIDAQABo0EwPzAfBgNV\nHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8EBTADAQH/MAsG\nA1UdDwQEAwIE8DANBgkqhkiG9w0BAQUFAAOCAQEAcrf3OLA+ug+6HkWejZldZPaZ\nIas6MNc6S3FKodRK6miU8MbMfF7PTYfgsP5CiBxCjjg3/0qfXlNcq5zQEOecdWkx\nqAG3y9ZRvTCfLW+T1tU0/5hXcHQzqI3ZmyfTe3dzdTmU+LG6vpcNEwrMed3gQ9Ld\nmwN7OVQPVdTh+0NezxOA5hKzgr4QQ0JErolBPsje5V81l9IfK+6VRZRToC+VQ3YP\nNUy64Z3lRl8ugJTAGfyZZdqkq6Qr7HJKI4rzd71MpDA9x/wwShiIgLnsJfF47v/S\nsZvz5MbgMNeNnKt/PVzf8EIQ9c5x0v/66R+Fu/TX3nXFYjbojqFiA6FHS1rfmQ==\n-----END CERTIFICATE----------BEGIN CERTIFICATE-----\nMIIDxjCCAq6gAwIBAgIJAO6DSG+Jvt0vMA0GCSqGSIb3DQEBDAUAMHAxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEOMAwGA1UECgwF\nVE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIwIAYJKoZIhvcNAQkBFhNUTUVTSEBub3Jk\nc3Ryb20uY29tMB4XDTE5MDMyODIxMTM0MFoXDTE5MDQyNzIxMTM0MFowcDELMAkG\nA1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQK\nDAVUTUVTSDEOMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5v\ncmRzdHJvbS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCeP6ez\n6jFDvmiK54pHhdH9/vwgteQ2SaPCCzH3+LPftE+98r9cYH7q+/AoHHaDUlK3CBRz\n63QrbKFNJfwY5LbEDKma+YR2zSMJLveDlW89hnuwVoCjdfThNqZOoqVOx1QFYBBv\nZ6lvtce2Oc5tmRwOfXudJTragqkMJme0Mn6CCy98R3VGysh7jnPJjb0JD2PygMMx\nKhGuzoM7Ib2Vf6vzOt4oqHFoHkCo1sgLvi7ojCo11ynB0pvequ6HElxgqEnoBUA7\npIhsqe4/gJyC62xjBKON48G/7Ut0xgXMmN0Ir+7nfBiGC8iBVy6smSv+qQ3dAxGx\nUbAUwTKNge9p+1Y3AgMBAAGjYzBhMB0GA1UdDgQWBBSYj5Tn7VrJSXj02YbqGnUv\nypxCGjAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8E\nBTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG9w0BAQwFAAOCAQEAcwQf730e\n6OhPRJ7yU5WVfARck3OgG1kWz4O3F0ZT9SC+85Q920jS3oBfaV2G4cTAsLgvk0rM\n62ghhN7BL/a06+iRkD7xO7w9ftcOReUqlaJ2SQi1L3eL6Cn6pu3mHwWyh3DqYdkW\n2y9SYGTWpmkIW/tG2k+/atnHeC7iEfxlO7Xq1aoAVBGJStR9JFQlETn52nRaG03r\ntMyEU+MrZhJDQR9gIFL/lBC/uLAkkNYqN7E4tbzc4n1rr1OuiTq3XeSdSGrxHkcp\nizHKiX1uPiG0iv5fI43XyTwHHlrfesYhxmFOv/I0HdsuFjQUHyPEq9pB0GsqKsoj\nL/EIQ1Caao5a3g==\n-----END CERTIFICATE-----"
	_, extractNoNewlineError := ExtractTrustChain(certChainWithNoNewline)
	if extractNoNewlineError != nil {
		t.Fail()
	}
	certChainAlreadyHasNewline := "-----BEGIN CERTIFICATE-----\nMIIDujCCAqKgAwIBAgICEAUwDQYJKoZIhvcNAQEFBQAwcDELMAkGA1UEBhMCVVMx\nCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQKDAVUTUVTSDEO\nMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5vcmRzdHJvbS5j\nb20wHhcNMTkwMzI5MjE0MDAwWhcNMjAwMzI4MjE0MDAwWjCBjDELMAkGA1UEBhMC\nVVMxEzARBgNVBAgMCldhc2hpbmd0b24xEDAOBgNVBAcMB1NlYXR0bGUxIjAgBgNV\nBAoMGVNPTl9PRl9URVNUX1BSSVZBVEVfVE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIw\nIAYDVQQDDBlTT05fT0ZfVEVTVF9QUklWQVRFX1RNRVNIMIIBIjANBgkqhkiG9w0B\nAQEFAAOCAQ8AMIIBCgKCAQEAxm0KSQwtnboTF3824PzcwPDakkzD9SuXUS4YxXgl\nJ8A6J3FQ/TI/5sbYl9LJsKCb9UEKz4Ao4X2ixWUACe5B9UO1YrWTpKnZ/mlNfTRC\nO6g+EwusTLcRqxepmYQq3Xu0r25EyT3l1vsCXOBI/BlfgRF6lXndwV6Mtqs+t7Yk\nKfFtzadcNc2hz8hm72L1P6d8LGxOTjavI06+tYz2iCm14pld7K5UzjdJVgHD2Aia\n9gL0pzoLSmdDjqKehtYWSx1xw4v6patZaaRxjbqA3zDzuEzsy1xmUHF44wlznOVL\nGseBmYA3DqW1YOGB//asg1ZRa0hEH7FIV8bktj9qTg7SfQIDAQABo0EwPzAfBgNV\nHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8EBTADAQH/MAsG\nA1UdDwQEAwIE8DANBgkqhkiG9w0BAQUFAAOCAQEAcrf3OLA+ug+6HkWejZldZPaZ\nIas6MNc6S3FKodRK6miU8MbMfF7PTYfgsP5CiBxCjjg3/0qfXlNcq5zQEOecdWkx\nqAG3y9ZRvTCfLW+T1tU0/5hXcHQzqI3ZmyfTe3dzdTmU+LG6vpcNEwrMed3gQ9Ld\nmwN7OVQPVdTh+0NezxOA5hKzgr4QQ0JErolBPsje5V81l9IfK+6VRZRToC+VQ3YP\nNUy64Z3lRl8ugJTAGfyZZdqkq6Qr7HJKI4rzd71MpDA9x/wwShiIgLnsJfF47v/S\nsZvz5MbgMNeNnKt/PVzf8EIQ9c5x0v/66R+Fu/TX3nXFYjbojqFiA6FHS1rfmQ==\n-----END CERTIFICATE-----\n-----BEGIN CERTIFICATE-----\nMIIDxjCCAq6gAwIBAgIJAO6DSG+Jvt0vMA0GCSqGSIb3DQEBDAUAMHAxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEOMAwGA1UECgwF\nVE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIwIAYJKoZIhvcNAQkBFhNUTUVTSEBub3Jk\nc3Ryb20uY29tMB4XDTE5MDMyODIxMTM0MFoXDTE5MDQyNzIxMTM0MFowcDELMAkG\nA1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQK\nDAVUTUVTSDEOMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5v\ncmRzdHJvbS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCeP6ez\n6jFDvmiK54pHhdH9/vwgteQ2SaPCCzH3+LPftE+98r9cYH7q+/AoHHaDUlK3CBRz\n63QrbKFNJfwY5LbEDKma+YR2zSMJLveDlW89hnuwVoCjdfThNqZOoqVOx1QFYBBv\nZ6lvtce2Oc5tmRwOfXudJTragqkMJme0Mn6CCy98R3VGysh7jnPJjb0JD2PygMMx\nKhGuzoM7Ib2Vf6vzOt4oqHFoHkCo1sgLvi7ojCo11ynB0pvequ6HElxgqEnoBUA7\npIhsqe4/gJyC62xjBKON48G/7Ut0xgXMmN0Ir+7nfBiGC8iBVy6smSv+qQ3dAxGx\nUbAUwTKNge9p+1Y3AgMBAAGjYzBhMB0GA1UdDgQWBBSYj5Tn7VrJSXj02YbqGnUv\nypxCGjAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8E\nBTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG9w0BAQwFAAOCAQEAcwQf730e\n6OhPRJ7yU5WVfARck3OgG1kWz4O3F0ZT9SC+85Q920jS3oBfaV2G4cTAsLgvk0rM\n62ghhN7BL/a06+iRkD7xO7w9ftcOReUqlaJ2SQi1L3eL6Cn6pu3mHwWyh3DqYdkW\n2y9SYGTWpmkIW/tG2k+/atnHeC7iEfxlO7Xq1aoAVBGJStR9JFQlETn52nRaG03r\ntMyEU+MrZhJDQR9gIFL/lBC/uLAkkNYqN7E4tbzc4n1rr1OuiTq3XeSdSGrxHkcp\nizHKiX1uPiG0iv5fI43XyTwHHlrfesYhxmFOv/I0HdsuFjQUHyPEq9pB0GsqKsoj\nL/EIQ1Caao5a3g==\n-----END CERTIFICATE-----"
	_, extractAlreadyHasNewlineError := ExtractTrustChain(certChainAlreadyHasNewline)
	if extractAlreadyHasNewlineError != nil {
		t.Fail()
	}
}
