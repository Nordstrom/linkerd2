---
kind: Namespace
apiVersion: v1
metadata:
  name: linkerd
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: linkerd-config
  namespace: linkerd
  labels:
    linkerd.io/control-plane-component: controller
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
data:
  global: |
    {"linkerdNamespace":"linkerd","cniEnabled":true,"version":"dev-ad8f5985-x37y","identityContext":{"trustDomain":"cluster.local","trustAnchorsPem":"-----BEGIN CERTIFICATE-----\nMIIDxjCCAq6gAwIBAgIJAO6DSG+Jvt0vMA0GCSqGSIb3DQEBDAUAMHAxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEOMAwGA1UECgwF\nVE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIwIAYJKoZIhvcNAQkBFhNUTUVTSEBub3Jk\nc3Ryb20uY29tMB4XDTE5MDMyODIxMTM0MFoXDTE5MDQyNzIxMTM0MFowcDELMAkG\nA1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQK\nDAVUTUVTSDEOMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5v\ncmRzdHJvbS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCeP6ez\n6jFDvmiK54pHhdH9/vwgteQ2SaPCCzH3+LPftE+98r9cYH7q+/AoHHaDUlK3CBRz\n63QrbKFNJfwY5LbEDKma+YR2zSMJLveDlW89hnuwVoCjdfThNqZOoqVOx1QFYBBv\nZ6lvtce2Oc5tmRwOfXudJTragqkMJme0Mn6CCy98R3VGysh7jnPJjb0JD2PygMMx\nKhGuzoM7Ib2Vf6vzOt4oqHFoHkCo1sgLvi7ojCo11ynB0pvequ6HElxgqEnoBUA7\npIhsqe4/gJyC62xjBKON48G/7Ut0xgXMmN0Ir+7nfBiGC8iBVy6smSv+qQ3dAxGx\nUbAUwTKNge9p+1Y3AgMBAAGjYzBhMB0GA1UdDgQWBBSYj5Tn7VrJSXj02YbqGnUv\nypxCGjAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8E\nBTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG9w0BAQwFAAOCAQEAcwQf730e\n6OhPRJ7yU5WVfARck3OgG1kWz4O3F0ZT9SC+85Q920jS3oBfaV2G4cTAsLgvk0rM\n62ghhN7BL/a06+iRkD7xO7w9ftcOReUqlaJ2SQi1L3eL6Cn6pu3mHwWyh3DqYdkW\n2y9SYGTWpmkIW/tG2k+/atnHeC7iEfxlO7Xq1aoAVBGJStR9JFQlETn52nRaG03r\ntMyEU+MrZhJDQR9gIFL/lBC/uLAkkNYqN7E4tbzc4n1rr1OuiTq3XeSdSGrxHkcp\nizHKiX1uPiG0iv5fI43XyTwHHlrfesYhxmFOv/I0HdsuFjQUHyPEq9pB0GsqKsoj\nL/EIQ1Caao5a3g==\n-----END CERTIFICATE-----\n","issuanceLifetime":"86400s","clockSkewAllowance":"20s"},"autoInjectContext":null}
  proxy: |
    {"proxyImage":{"imageName":"gcr.io/linkerd-io/proxy","pullPolicy":"IfNotPresent"},"proxyInitImage":{"imageName":"gcr.io/linkerd-io/proxy-init","pullPolicy":"IfNotPresent"},"controlPort":{"port":4190},"ignoreInboundPorts":[],"ignoreOutboundPorts":[],"inboundPort":{"port":4143},"adminPort":{"port":4191},"outboundPort":{"port":4140},"resource":{"requestCpu":"","requestMemory":"","limitCpu":"","limitMemory":""},"proxyUid":"2102","logLevel":{"level":"warn,linkerd2_proxy=info"},"disableExternalProfiles":true}
  install: |
    {"uuid":"96009935-e45c-4f44-89a6-02488409a8b2","cliVersion":"dev-ad8f5985-x37y","flags":[{"name":"linkerd-cni-enabled","value":"true"}]}
---
###
### Identity Controller Service
###
---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: linkerd-identity
  namespace: linkerd
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: linkerd-linkerd-identity
rules:
- apiGroups: ["authentication.k8s.io"]
  resources: ["tokenreviews"]
  verbs: ["create"]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: linkerd-linkerd-identity
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: linkerd-linkerd-identity
subjects:
- kind: ServiceAccount
  name: linkerd-identity
  namespace: linkerd
---
kind: Service
apiVersion: v1
metadata:
  name: linkerd-identity
  namespace: linkerd
  labels:
    linkerd.io/control-plane-component: identity
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
spec:
  type: ClusterIP
  selector:
    linkerd.io/control-plane-component: identity
  ports:
  - name: grpc
    port: 8080
    targetPort: 8080
---
kind: Secret
apiVersion: v1
metadata:
  name: linkerd-identity-issuer
  namespace: linkerd
  labels:
    linkerd.io/control-plane-component: identity
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
    linkerd.io/identity-issuer-expiry: 2029-04-09T20:35:04Z
data:
  crt.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM3RENDQWRTZ0F3SUJBZ0lSQUtOV3FzTHE4LzgrKzBlTVIwVENRaUl3RFFZSktvWklodmNOQVFFTEJRQXcKY0RFTE1Ba0dBMVVFQmhNQ1ZWTXhDekFKQmdOVkJBZ01BbGRCTVJBd0RnWURWUVFIREFkVFpXRjBkR3hsTVE0dwpEQVlEVlFRS0RBVlVUVVZUU0RFT01Bd0dBMVVFQ3d3RlZFMUZVMGd4SWpBZ0Jna3Foa2lHOXcwQkNRRVdFMVJOClJWTklRRzV2Y21SemRISnZiUzVqYjIwd0hoY05NVGt3TkRFeU1qQXpOVEEwV2hjTk1qa3dOREE1TWpBek5UQTAKV2pBcE1TY3dKUVlEVlFRREV4NXBaR1Z1ZEdsMGVTNXNhVzVyWlhKa0xtTnNkWE4wWlhJdWJHOWpZV3d3V1RBVApCZ2NxaGtqT1BRSUJCZ2dxaGtqT1BRTUJCd05DQUFTRDg4cHNDdm1qeWRDeXNNN0Q5YXF2d2Z0NGtwdjRyY2VhCjRpWFYwY2VUazNHOW9DVUphWUoyeGlXTFlpVXRvdTJnZERQakFubWhLTXo0NjRBcW5hcHdvNEdTTUlHUE1BNEcKQTFVZER3RUIvd1FFQXdJQkJqQVNCZ05WSFJNQkFmOEVDREFHQVFIL0FnRUFNQjBHQTFVZERnUVdCQlM5WVRsKwpRM0RYNkJKYVpVRU9xTFZMM0VVUjZ6QWZCZ05WSFNNRUdEQVdnQlNZajVUbjdWckpTWGowMllicUduVXZ5cHhDCkdqQXBCZ05WSFJFRUlqQWdnaDVwWkdWdWRHbDBlUzVzYVc1clpYSmtMbU5zZFhOMFpYSXViRzlqWVd3d0RRWUoKS29aSWh2Y05BUUVMQlFBRGdnRUJBR1ZrZFFsckl3RnQzUThBeSsxWmdydjNBaGdBQnUzbXFDVFVGc3hyQk9GOApGWGwybXJtSk5xUXBTelI2L0NnaVRmUHBCeElYK1FOTGl0UUN5bXB4U0VqUnNZTkwzeFFkN3cvT0ZCRjhhbTJHCmhZanA1RnRqMmxrUFBUOSt2QW5RUHIzYjhFK3d2OXJhVU5MaCtxQ0VKYkJkVnhhZVo4VkpHM0lqbldFclVBR1QKdlFBbDV6ejlGSjNLa0trWW1kVmc5S3owY1NEYUh2K1UvaHU1VFN6c1RDSEQ0UUlCaksxY1JlQzRBMldaTlVxUwpPcVZTRlJpREdqcDVJZnMxZEI4bEdHV2JCMnFNRU9IK0E0eUlVUG1QNlJSTk1PVUk3NFhNOWk1cjRVelkvTTVUClR1MjNoRGE5dVUwZzBpL20zeDdSaW5Cb0VyNzdpb2hRQ012ekdaQ1ovMjQ9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  key.pem: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSU5kTUREek1wTTRCOWgvcm9NNWI1b3c4MzBsdzN2MTJNcmdSUDZqTnUrYzFvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFZy9QS2JBcjVvOG5Rc3JET3cvV3FyOEg3ZUpLYitLM0htdUlsMWRISGs1Tnh2YUFsQ1dtQwpkc1lsaTJJbExhTHRvSFF6NHdKNW9Tak0rT3VBS3AycWNBPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
  creationTimestamp: null
  labels:
    linkerd.io/control-plane-component: identity
  name: linkerd-identity
  namespace: linkerd
spec:
  replicas: 1
  strategy: {}
  template:
    metadata:
      annotations:
        linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
        linkerd.io/identity-mode: default
        linkerd.io/proxy-version: dev-ad8f5985-x37y
      creationTimestamp: null
      labels:
        linkerd.io/control-plane-component: identity
        linkerd.io/control-plane-ns: linkerd
        linkerd.io/proxy-deployment: linkerd-identity
    spec:
      containers:
      - args:
        - identity
        - -log-level=info
        image: gcr.io/linkerd-io/controller:dev-ad8f5985-x37y
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /ping
            port: 9990
          initialDelaySeconds: 10
        name: identity
        ports:
        - containerPort: 8080
          name: grpc
        - containerPort: 9990
          name: admin-http
        readinessProbe:
          failureThreshold: 7
          httpGet:
            path: /ready
            port: 9990
        resources: {}
        securityContext:
          runAsUser: 2103
        volumeMounts:
        - mountPath: /var/run/linkerd/config
          name: config
        - mountPath: /var/run/linkerd/identity/issuer
          name: identity-issuer
      - env:
        - name: LINKERD2_PROXY_LOG
          value: warn,linkerd2_proxy=info
        - name: LINKERD2_PROXY_DESTINATION_SVC_ADDR
          value: linkerd-destination.linkerd.svc.cluster.local:8086
        - name: LINKERD2_PROXY_CONTROL_LISTEN_ADDR
          value: 0.0.0.0:4190
        - name: LINKERD2_PROXY_ADMIN_LISTEN_ADDR
          value: 0.0.0.0:4191
        - name: LINKERD2_PROXY_OUTBOUND_LISTEN_ADDR
          value: 127.0.0.1:4140
        - name: LINKERD2_PROXY_INBOUND_LISTEN_ADDR
          value: 0.0.0.0:4143
        - name: LINKERD2_PROXY_DESTINATION_PROFILE_SUFFIXES
          value: svc.cluster.local.
        - name: LINKERD2_PROXY_INBOUND_ACCEPT_KEEPALIVE
          value: 10000ms
        - name: LINKERD2_PROXY_OUTBOUND_CONNECT_KEEPALIVE
          value: 10000ms
        - name: _pod_ns
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: LINKERD2_PROXY_DESTINATION_CONTEXT
          value: ns:$(_pod_ns)
        - name: LINKERD2_PROXY_IDENTITY_DIR
          value: /var/run/linkerd/identity/end-entity
        - name: LINKERD2_PROXY_IDENTITY_TRUST_ANCHORS
          value: |
            -----BEGIN CERTIFICATE-----
            MIIDxjCCAq6gAwIBAgIJAO6DSG+Jvt0vMA0GCSqGSIb3DQEBDAUAMHAxCzAJBgNV
            BAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEOMAwGA1UECgwF
            VE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIwIAYJKoZIhvcNAQkBFhNUTUVTSEBub3Jk
            c3Ryb20uY29tMB4XDTE5MDMyODIxMTM0MFoXDTE5MDQyNzIxMTM0MFowcDELMAkG
            A1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQK
            DAVUTUVTSDEOMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5v
            cmRzdHJvbS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCeP6ez
            6jFDvmiK54pHhdH9/vwgteQ2SaPCCzH3+LPftE+98r9cYH7q+/AoHHaDUlK3CBRz
            63QrbKFNJfwY5LbEDKma+YR2zSMJLveDlW89hnuwVoCjdfThNqZOoqVOx1QFYBBv
            Z6lvtce2Oc5tmRwOfXudJTragqkMJme0Mn6CCy98R3VGysh7jnPJjb0JD2PygMMx
            KhGuzoM7Ib2Vf6vzOt4oqHFoHkCo1sgLvi7ojCo11ynB0pvequ6HElxgqEnoBUA7
            pIhsqe4/gJyC62xjBKON48G/7Ut0xgXMmN0Ir+7nfBiGC8iBVy6smSv+qQ3dAxGx
            UbAUwTKNge9p+1Y3AgMBAAGjYzBhMB0GA1UdDgQWBBSYj5Tn7VrJSXj02YbqGnUv
            ypxCGjAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8E
            BTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG9w0BAQwFAAOCAQEAcwQf730e
            6OhPRJ7yU5WVfARck3OgG1kWz4O3F0ZT9SC+85Q920jS3oBfaV2G4cTAsLgvk0rM
            62ghhN7BL/a06+iRkD7xO7w9ftcOReUqlaJ2SQi1L3eL6Cn6pu3mHwWyh3DqYdkW
            2y9SYGTWpmkIW/tG2k+/atnHeC7iEfxlO7Xq1aoAVBGJStR9JFQlETn52nRaG03r
            tMyEU+MrZhJDQR9gIFL/lBC/uLAkkNYqN7E4tbzc4n1rr1OuiTq3XeSdSGrxHkcp
            izHKiX1uPiG0iv5fI43XyTwHHlrfesYhxmFOv/I0HdsuFjQUHyPEq9pB0GsqKsoj
            L/EIQ1Caao5a3g==
            -----END CERTIFICATE-----
        - name: LINKERD2_PROXY_IDENTITY_TOKEN_FILE
          value: /var/run/secrets/kubernetes.io/serviceaccount/token
        - name: LINKERD2_PROXY_IDENTITY_SVC_ADDR
          value: localhost.:8080
        - name: _pod_sa
          valueFrom:
            fieldRef:
              fieldPath: spec.serviceAccountName
        - name: _l5d_ns
          value: linkerd
        - name: _l5d_trustdomain
          value: cluster.local
        - name: LINKERD2_PROXY_IDENTITY_LOCAL_NAME
          value: $(_pod_sa).$(_pod_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        - name: LINKERD2_PROXY_IDENTITY_SVC_NAME
          value: linkerd-identity.$(_l5d_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        - name: LINKERD2_PROXY_DESTINATION_SVC_NAME
          value: linkerd-controller.$(_l5d_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        image: gcr.io/linkerd-io/proxy:dev-ad8f5985-x37y
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /metrics
            port: 4191
          initialDelaySeconds: 10
        name: linkerd-proxy
        ports:
        - containerPort: 4143
          name: linkerd-proxy
        - containerPort: 4191
          name: linkerd-admin
        readinessProbe:
          httpGet:
            path: /ready
            port: 4191
          initialDelaySeconds: 2
        resources: {}
        securityContext:
          runAsUser: 2102
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /var/run/linkerd/identity/end-entity
          name: linkerd-identity-end-entity
      serviceAccountName: linkerd-identity
      volumes:
      - configMap:
          name: linkerd-config
        name: config
      - name: identity-issuer
        secret:
          secretName: linkerd-identity-issuer
      - emptyDir:
          medium: Memory
        name: linkerd-identity-end-entity
status: {}
---
###
### Controller
###
---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: linkerd-controller
  namespace: linkerd
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: linkerd-linkerd-controller
rules:
- apiGroups: ["extensions", "apps"]
  resources: ["daemonsets", "deployments", "replicasets", "statefulsets"]
  verbs: ["list", "get", "watch"]
- apiGroups: ["extensions", "batch"]
  resources: ["jobs"]
  verbs: ["list" , "get", "watch"]
- apiGroups: [""]
  resources: ["pods", "endpoints", "services", "replicationcontrollers", "namespaces"]
  verbs: ["list", "get", "watch"]
- apiGroups: ["linkerd.io"]
  resources: ["serviceprofiles"]
  verbs: ["list", "get", "watch"]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: linkerd-linkerd-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: linkerd-linkerd-controller
subjects:
- kind: ServiceAccount
  name: linkerd-controller
  namespace: linkerd
---
kind: Service
apiVersion: v1
metadata:
  name: linkerd-controller-api
  namespace: linkerd
  labels:
    linkerd.io/control-plane-component: controller
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
spec:
  type: ClusterIP
  selector:
    linkerd.io/control-plane-component: controller
  ports:
  - name: http
    port: 8085
    targetPort: 8085
---
kind: Service
apiVersion: v1
metadata:
  name: linkerd-destination
  namespace: linkerd
  labels:
    linkerd.io/control-plane-component: controller
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
spec:
  type: ClusterIP
  selector:
    linkerd.io/control-plane-component: controller
  ports:
  - name: grpc
    port: 8086
    targetPort: 8086
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
  creationTimestamp: null
  labels:
    linkerd.io/control-plane-component: controller
  name: linkerd-controller
  namespace: linkerd
spec:
  replicas: 1
  strategy: {}
  template:
    metadata:
      annotations:
        linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
        linkerd.io/identity-mode: default
        linkerd.io/proxy-version: dev-ad8f5985-x37y
      creationTimestamp: null
      labels:
        linkerd.io/control-plane-component: controller
        linkerd.io/control-plane-ns: linkerd
        linkerd.io/proxy-deployment: linkerd-controller
    spec:
      containers:
      - args:
        - public-api
        - -prometheus-url=http://linkerd-prometheus.linkerd.svc.cluster.local:9090
        - -controller-namespace=linkerd
        - -log-level=info
        image: gcr.io/linkerd-io/controller:dev-ad8f5985-x37y
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /ping
            port: 9995
          initialDelaySeconds: 10
        name: public-api
        ports:
        - containerPort: 8085
          name: http
        - containerPort: 9995
          name: admin-http
        readinessProbe:
          failureThreshold: 7
          httpGet:
            path: /ready
            port: 9995
        resources: {}
        securityContext:
          runAsUser: 2103
        volumeMounts:
        - mountPath: /var/run/linkerd/config
          name: config
      - args:
        - destination
        - -addr=:8086
        - -controller-namespace=linkerd
        - -enable-h2-upgrade=true
        - -log-level=info
        image: gcr.io/linkerd-io/controller:dev-ad8f5985-x37y
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /ping
            port: 9996
          initialDelaySeconds: 10
        name: destination
        ports:
        - containerPort: 8086
          name: grpc
        - containerPort: 9996
          name: admin-http
        readinessProbe:
          failureThreshold: 7
          httpGet:
            path: /ready
            port: 9996
        resources: {}
        securityContext:
          runAsUser: 2103
        volumeMounts:
        - mountPath: /var/run/linkerd/config
          name: config
      - args:
        - tap
        - -controller-namespace=linkerd
        - -log-level=info
        image: gcr.io/linkerd-io/controller:dev-ad8f5985-x37y
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /ping
            port: 9998
          initialDelaySeconds: 10
        name: tap
        ports:
        - containerPort: 8088
          name: grpc
        - containerPort: 9998
          name: admin-http
        readinessProbe:
          failureThreshold: 7
          httpGet:
            path: /ready
            port: 9998
        resources: {}
        securityContext:
          runAsUser: 2103
      - env:
        - name: LINKERD2_PROXY_LOG
          value: warn,linkerd2_proxy=info
        - name: LINKERD2_PROXY_DESTINATION_SVC_ADDR
          value: localhost.:8086
        - name: LINKERD2_PROXY_CONTROL_LISTEN_ADDR
          value: 0.0.0.0:4190
        - name: LINKERD2_PROXY_ADMIN_LISTEN_ADDR
          value: 0.0.0.0:4191
        - name: LINKERD2_PROXY_OUTBOUND_LISTEN_ADDR
          value: 127.0.0.1:4140
        - name: LINKERD2_PROXY_INBOUND_LISTEN_ADDR
          value: 0.0.0.0:4143
        - name: LINKERD2_PROXY_DESTINATION_PROFILE_SUFFIXES
          value: svc.cluster.local.
        - name: LINKERD2_PROXY_INBOUND_ACCEPT_KEEPALIVE
          value: 10000ms
        - name: LINKERD2_PROXY_OUTBOUND_CONNECT_KEEPALIVE
          value: 10000ms
        - name: _pod_ns
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: LINKERD2_PROXY_DESTINATION_CONTEXT
          value: ns:$(_pod_ns)
        - name: LINKERD2_PROXY_IDENTITY_DIR
          value: /var/run/linkerd/identity/end-entity
        - name: LINKERD2_PROXY_IDENTITY_TRUST_ANCHORS
          value: |
            -----BEGIN CERTIFICATE-----
            MIIDxjCCAq6gAwIBAgIJAO6DSG+Jvt0vMA0GCSqGSIb3DQEBDAUAMHAxCzAJBgNV
            BAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEOMAwGA1UECgwF
            VE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIwIAYJKoZIhvcNAQkBFhNUTUVTSEBub3Jk
            c3Ryb20uY29tMB4XDTE5MDMyODIxMTM0MFoXDTE5MDQyNzIxMTM0MFowcDELMAkG
            A1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQK
            DAVUTUVTSDEOMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5v
            cmRzdHJvbS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCeP6ez
            6jFDvmiK54pHhdH9/vwgteQ2SaPCCzH3+LPftE+98r9cYH7q+/AoHHaDUlK3CBRz
            63QrbKFNJfwY5LbEDKma+YR2zSMJLveDlW89hnuwVoCjdfThNqZOoqVOx1QFYBBv
            Z6lvtce2Oc5tmRwOfXudJTragqkMJme0Mn6CCy98R3VGysh7jnPJjb0JD2PygMMx
            KhGuzoM7Ib2Vf6vzOt4oqHFoHkCo1sgLvi7ojCo11ynB0pvequ6HElxgqEnoBUA7
            pIhsqe4/gJyC62xjBKON48G/7Ut0xgXMmN0Ir+7nfBiGC8iBVy6smSv+qQ3dAxGx
            UbAUwTKNge9p+1Y3AgMBAAGjYzBhMB0GA1UdDgQWBBSYj5Tn7VrJSXj02YbqGnUv
            ypxCGjAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8E
            BTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG9w0BAQwFAAOCAQEAcwQf730e
            6OhPRJ7yU5WVfARck3OgG1kWz4O3F0ZT9SC+85Q920jS3oBfaV2G4cTAsLgvk0rM
            62ghhN7BL/a06+iRkD7xO7w9ftcOReUqlaJ2SQi1L3eL6Cn6pu3mHwWyh3DqYdkW
            2y9SYGTWpmkIW/tG2k+/atnHeC7iEfxlO7Xq1aoAVBGJStR9JFQlETn52nRaG03r
            tMyEU+MrZhJDQR9gIFL/lBC/uLAkkNYqN7E4tbzc4n1rr1OuiTq3XeSdSGrxHkcp
            izHKiX1uPiG0iv5fI43XyTwHHlrfesYhxmFOv/I0HdsuFjQUHyPEq9pB0GsqKsoj
            L/EIQ1Caao5a3g==
            -----END CERTIFICATE-----
        - name: LINKERD2_PROXY_IDENTITY_TOKEN_FILE
          value: /var/run/secrets/kubernetes.io/serviceaccount/token
        - name: LINKERD2_PROXY_IDENTITY_SVC_ADDR
          value: linkerd-identity.linkerd.svc.cluster.local:8080
        - name: _pod_sa
          valueFrom:
            fieldRef:
              fieldPath: spec.serviceAccountName
        - name: _l5d_ns
          value: linkerd
        - name: _l5d_trustdomain
          value: cluster.local
        - name: LINKERD2_PROXY_IDENTITY_LOCAL_NAME
          value: $(_pod_sa).$(_pod_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        - name: LINKERD2_PROXY_IDENTITY_SVC_NAME
          value: linkerd-identity.$(_l5d_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        - name: LINKERD2_PROXY_DESTINATION_SVC_NAME
          value: linkerd-controller.$(_l5d_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        image: gcr.io/linkerd-io/proxy:dev-ad8f5985-x37y
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /metrics
            port: 4191
          initialDelaySeconds: 10
        name: linkerd-proxy
        ports:
        - containerPort: 4143
          name: linkerd-proxy
        - containerPort: 4191
          name: linkerd-admin
        readinessProbe:
          httpGet:
            path: /ready
            port: 4191
          initialDelaySeconds: 2
        resources: {}
        securityContext:
          runAsUser: 2102
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /var/run/linkerd/identity/end-entity
          name: linkerd-identity-end-entity
      serviceAccountName: linkerd-controller
      volumes:
      - configMap:
          name: linkerd-config
        name: config
      - emptyDir:
          medium: Memory
        name: linkerd-identity-end-entity
status: {}
---
###
### Service Profile CRD
###
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: serviceprofiles.linkerd.io
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
spec:
  group: linkerd.io
  version: v1alpha1
  scope: Namespaced
  names:
    plural: serviceprofiles
    singular: serviceprofile
    kind: ServiceProfile
    shortNames:
    - sp
  validation:
    openAPIV3Schema:
      properties:
        spec:
          required:
          - routes
          properties:
            retryBudget:
              required:
              - minRetriesPerSecond
              - retryRatio
              - ttl
              type: object
              properties:
                minRetriesPerSecond:
                  type: integer
                retryRatio:
                  type: number
                ttl:
                  type: string
            routes:
              type: array
              items:
                type: object
                required:
                - name
                - condition
                properties:
                  name:
                    type: string
                  timeout:
                    type: string
                  condition:
                    type: object
                    minProperties: 1
                    properties:
                      method:
                        type: string
                      pathRegex:
                        type: string
                      all:
                        type: array
                        items:
                          type: object
                      any:
                        type: array
                        items:
                          type: object
                      not:
                        type: object
                  responseClasses:
                    type: array
                    items:
                      type: object
                      required:
                      - condition
                      properties:
                        isFailure:
                          type: boolean
                        condition:
                          type: object
                          properties:
                            status:
                              type: object
                              minProperties: 1
                              properties:
                                min:
                                  type: integer
                                  minimum: 100
                                  maximum: 599
                                max:
                                  type: integer
                                  minimum: 100
                                  maximum: 599
                            all:
                              type: array
                              items:
                                type: object
                            any:
                              type: array
                              items:
                                type: object
                            not:
                              type: object
---
###
### Web
###
---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: linkerd-web
  namespace: linkerd
---
kind: Service
apiVersion: v1
metadata:
  name: linkerd-web
  namespace: linkerd
  labels:
    linkerd.io/control-plane-component: web
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
spec:
  type: ClusterIP
  selector:
    linkerd.io/control-plane-component: web
  ports:
  - name: http
    port: 8084
    targetPort: 8084
  - name: admin-http
    port: 9994
    targetPort: 9994
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
  creationTimestamp: null
  labels:
    linkerd.io/control-plane-component: web
  name: linkerd-web
  namespace: linkerd
spec:
  replicas: 1
  strategy: {}
  template:
    metadata:
      annotations:
        linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
        linkerd.io/identity-mode: default
        linkerd.io/proxy-version: dev-ad8f5985-x37y
      creationTimestamp: null
      labels:
        linkerd.io/control-plane-component: web
        linkerd.io/control-plane-ns: linkerd
        linkerd.io/proxy-deployment: linkerd-web
    spec:
      containers:
      - args:
        - -api-addr=linkerd-controller-api.linkerd.svc.cluster.local:8085
        - -grafana-addr=linkerd-grafana.linkerd.svc.cluster.local:3000
        - -controller-namespace=linkerd
        - -log-level=info
        image: gcr.io/linkerd-io/web:dev-ad8f5985-x37y
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /ping
            port: 9994
          initialDelaySeconds: 10
        name: web
        ports:
        - containerPort: 8084
          name: http
        - containerPort: 9994
          name: admin-http
        readinessProbe:
          failureThreshold: 7
          httpGet:
            path: /ready
            port: 9994
        resources: {}
        securityContext:
          runAsUser: 2103
        volumeMounts:
        - mountPath: /var/run/linkerd/config
          name: config
      - env:
        - name: LINKERD2_PROXY_LOG
          value: warn,linkerd2_proxy=info
        - name: LINKERD2_PROXY_DESTINATION_SVC_ADDR
          value: linkerd-destination.linkerd.svc.cluster.local:8086
        - name: LINKERD2_PROXY_CONTROL_LISTEN_ADDR
          value: 0.0.0.0:4190
        - name: LINKERD2_PROXY_ADMIN_LISTEN_ADDR
          value: 0.0.0.0:4191
        - name: LINKERD2_PROXY_OUTBOUND_LISTEN_ADDR
          value: 127.0.0.1:4140
        - name: LINKERD2_PROXY_INBOUND_LISTEN_ADDR
          value: 0.0.0.0:4143
        - name: LINKERD2_PROXY_DESTINATION_PROFILE_SUFFIXES
          value: svc.cluster.local.
        - name: LINKERD2_PROXY_INBOUND_ACCEPT_KEEPALIVE
          value: 10000ms
        - name: LINKERD2_PROXY_OUTBOUND_CONNECT_KEEPALIVE
          value: 10000ms
        - name: _pod_ns
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: LINKERD2_PROXY_DESTINATION_CONTEXT
          value: ns:$(_pod_ns)
        - name: LINKERD2_PROXY_IDENTITY_DIR
          value: /var/run/linkerd/identity/end-entity
        - name: LINKERD2_PROXY_IDENTITY_TRUST_ANCHORS
          value: |
            -----BEGIN CERTIFICATE-----
            MIIDxjCCAq6gAwIBAgIJAO6DSG+Jvt0vMA0GCSqGSIb3DQEBDAUAMHAxCzAJBgNV
            BAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEOMAwGA1UECgwF
            VE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIwIAYJKoZIhvcNAQkBFhNUTUVTSEBub3Jk
            c3Ryb20uY29tMB4XDTE5MDMyODIxMTM0MFoXDTE5MDQyNzIxMTM0MFowcDELMAkG
            A1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQK
            DAVUTUVTSDEOMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5v
            cmRzdHJvbS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCeP6ez
            6jFDvmiK54pHhdH9/vwgteQ2SaPCCzH3+LPftE+98r9cYH7q+/AoHHaDUlK3CBRz
            63QrbKFNJfwY5LbEDKma+YR2zSMJLveDlW89hnuwVoCjdfThNqZOoqVOx1QFYBBv
            Z6lvtce2Oc5tmRwOfXudJTragqkMJme0Mn6CCy98R3VGysh7jnPJjb0JD2PygMMx
            KhGuzoM7Ib2Vf6vzOt4oqHFoHkCo1sgLvi7ojCo11ynB0pvequ6HElxgqEnoBUA7
            pIhsqe4/gJyC62xjBKON48G/7Ut0xgXMmN0Ir+7nfBiGC8iBVy6smSv+qQ3dAxGx
            UbAUwTKNge9p+1Y3AgMBAAGjYzBhMB0GA1UdDgQWBBSYj5Tn7VrJSXj02YbqGnUv
            ypxCGjAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8E
            BTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG9w0BAQwFAAOCAQEAcwQf730e
            6OhPRJ7yU5WVfARck3OgG1kWz4O3F0ZT9SC+85Q920jS3oBfaV2G4cTAsLgvk0rM
            62ghhN7BL/a06+iRkD7xO7w9ftcOReUqlaJ2SQi1L3eL6Cn6pu3mHwWyh3DqYdkW
            2y9SYGTWpmkIW/tG2k+/atnHeC7iEfxlO7Xq1aoAVBGJStR9JFQlETn52nRaG03r
            tMyEU+MrZhJDQR9gIFL/lBC/uLAkkNYqN7E4tbzc4n1rr1OuiTq3XeSdSGrxHkcp
            izHKiX1uPiG0iv5fI43XyTwHHlrfesYhxmFOv/I0HdsuFjQUHyPEq9pB0GsqKsoj
            L/EIQ1Caao5a3g==
            -----END CERTIFICATE-----
        - name: LINKERD2_PROXY_IDENTITY_TOKEN_FILE
          value: /var/run/secrets/kubernetes.io/serviceaccount/token
        - name: LINKERD2_PROXY_IDENTITY_SVC_ADDR
          value: linkerd-identity.linkerd.svc.cluster.local:8080
        - name: _pod_sa
          valueFrom:
            fieldRef:
              fieldPath: spec.serviceAccountName
        - name: _l5d_ns
          value: linkerd
        - name: _l5d_trustdomain
          value: cluster.local
        - name: LINKERD2_PROXY_IDENTITY_LOCAL_NAME
          value: $(_pod_sa).$(_pod_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        - name: LINKERD2_PROXY_IDENTITY_SVC_NAME
          value: linkerd-identity.$(_l5d_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        - name: LINKERD2_PROXY_DESTINATION_SVC_NAME
          value: linkerd-controller.$(_l5d_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        image: gcr.io/linkerd-io/proxy:dev-ad8f5985-x37y
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /metrics
            port: 4191
          initialDelaySeconds: 10
        name: linkerd-proxy
        ports:
        - containerPort: 4143
          name: linkerd-proxy
        - containerPort: 4191
          name: linkerd-admin
        readinessProbe:
          httpGet:
            path: /ready
            port: 4191
          initialDelaySeconds: 2
        resources: {}
        securityContext:
          runAsUser: 2102
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /var/run/linkerd/identity/end-entity
          name: linkerd-identity-end-entity
      serviceAccountName: linkerd-web
      volumes:
      - configMap:
          name: linkerd-config
        name: config
      - emptyDir:
          medium: Memory
        name: linkerd-identity-end-entity
status: {}
---
###
### Prometheus
###
---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: linkerd-prometheus
  namespace: linkerd
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: linkerd-linkerd-prometheus
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: linkerd-linkerd-prometheus
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: linkerd-linkerd-prometheus
subjects:
- kind: ServiceAccount
  name: linkerd-prometheus
  namespace: linkerd
---
kind: Service
apiVersion: v1
metadata:
  name: linkerd-prometheus
  namespace: linkerd
  labels:
    linkerd.io/control-plane-component: prometheus
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
spec:
  type: ClusterIP
  selector:
    linkerd.io/control-plane-component: prometheus
  ports:
  - name: admin-http
    port: 9090
    targetPort: 9090
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
  creationTimestamp: null
  labels:
    linkerd.io/control-plane-component: prometheus
  name: linkerd-prometheus
  namespace: linkerd
spec:
  replicas: 1
  strategy: {}
  template:
    metadata:
      annotations:
        linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
        linkerd.io/identity-mode: default
        linkerd.io/proxy-version: dev-ad8f5985-x37y
      creationTimestamp: null
      labels:
        linkerd.io/control-plane-component: prometheus
        linkerd.io/control-plane-ns: linkerd
        linkerd.io/proxy-deployment: linkerd-prometheus
    spec:
      containers:
      - args:
        - --storage.tsdb.path=/data
        - --storage.tsdb.retention.time=6h
        - --config.file=/etc/prometheus/prometheus.yml
        - --log.level=info
        image: prom/prometheus:v2.7.1
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /-/healthy
            port: 9090
          initialDelaySeconds: 30
          timeoutSeconds: 30
        name: prometheus
        ports:
        - containerPort: 9090
          name: admin-http
        readinessProbe:
          httpGet:
            path: /-/ready
            port: 9090
          initialDelaySeconds: 30
          timeoutSeconds: 30
        resources: {}
        securityContext:
          runAsUser: 65534
        volumeMounts:
        - mountPath: /data
          name: data
        - mountPath: /etc/prometheus
          name: prometheus-config
          readOnly: true
      - env:
        - name: LINKERD2_PROXY_LOG
          value: warn,linkerd2_proxy=info
        - name: LINKERD2_PROXY_DESTINATION_SVC_ADDR
          value: linkerd-destination.linkerd.svc.cluster.local:8086
        - name: LINKERD2_PROXY_CONTROL_LISTEN_ADDR
          value: 0.0.0.0:4190
        - name: LINKERD2_PROXY_ADMIN_LISTEN_ADDR
          value: 0.0.0.0:4191
        - name: LINKERD2_PROXY_OUTBOUND_LISTEN_ADDR
          value: 127.0.0.1:4140
        - name: LINKERD2_PROXY_INBOUND_LISTEN_ADDR
          value: 0.0.0.0:4143
        - name: LINKERD2_PROXY_DESTINATION_PROFILE_SUFFIXES
          value: svc.cluster.local.
        - name: LINKERD2_PROXY_INBOUND_ACCEPT_KEEPALIVE
          value: 10000ms
        - name: LINKERD2_PROXY_OUTBOUND_CONNECT_KEEPALIVE
          value: 10000ms
        - name: _pod_ns
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: LINKERD2_PROXY_DESTINATION_CONTEXT
          value: ns:$(_pod_ns)
        - name: LINKERD2_PROXY_OUTBOUND_ROUTER_CAPACITY
          value: "10000"
        - name: LINKERD2_PROXY_IDENTITY_DIR
          value: /var/run/linkerd/identity/end-entity
        - name: LINKERD2_PROXY_IDENTITY_TRUST_ANCHORS
          value: |
            -----BEGIN CERTIFICATE-----
            MIIDxjCCAq6gAwIBAgIJAO6DSG+Jvt0vMA0GCSqGSIb3DQEBDAUAMHAxCzAJBgNV
            BAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEOMAwGA1UECgwF
            VE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIwIAYJKoZIhvcNAQkBFhNUTUVTSEBub3Jk
            c3Ryb20uY29tMB4XDTE5MDMyODIxMTM0MFoXDTE5MDQyNzIxMTM0MFowcDELMAkG
            A1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQK
            DAVUTUVTSDEOMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5v
            cmRzdHJvbS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCeP6ez
            6jFDvmiK54pHhdH9/vwgteQ2SaPCCzH3+LPftE+98r9cYH7q+/AoHHaDUlK3CBRz
            63QrbKFNJfwY5LbEDKma+YR2zSMJLveDlW89hnuwVoCjdfThNqZOoqVOx1QFYBBv
            Z6lvtce2Oc5tmRwOfXudJTragqkMJme0Mn6CCy98R3VGysh7jnPJjb0JD2PygMMx
            KhGuzoM7Ib2Vf6vzOt4oqHFoHkCo1sgLvi7ojCo11ynB0pvequ6HElxgqEnoBUA7
            pIhsqe4/gJyC62xjBKON48G/7Ut0xgXMmN0Ir+7nfBiGC8iBVy6smSv+qQ3dAxGx
            UbAUwTKNge9p+1Y3AgMBAAGjYzBhMB0GA1UdDgQWBBSYj5Tn7VrJSXj02YbqGnUv
            ypxCGjAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8E
            BTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG9w0BAQwFAAOCAQEAcwQf730e
            6OhPRJ7yU5WVfARck3OgG1kWz4O3F0ZT9SC+85Q920jS3oBfaV2G4cTAsLgvk0rM
            62ghhN7BL/a06+iRkD7xO7w9ftcOReUqlaJ2SQi1L3eL6Cn6pu3mHwWyh3DqYdkW
            2y9SYGTWpmkIW/tG2k+/atnHeC7iEfxlO7Xq1aoAVBGJStR9JFQlETn52nRaG03r
            tMyEU+MrZhJDQR9gIFL/lBC/uLAkkNYqN7E4tbzc4n1rr1OuiTq3XeSdSGrxHkcp
            izHKiX1uPiG0iv5fI43XyTwHHlrfesYhxmFOv/I0HdsuFjQUHyPEq9pB0GsqKsoj
            L/EIQ1Caao5a3g==
            -----END CERTIFICATE-----
        - name: LINKERD2_PROXY_IDENTITY_TOKEN_FILE
          value: /var/run/secrets/kubernetes.io/serviceaccount/token
        - name: LINKERD2_PROXY_IDENTITY_SVC_ADDR
          value: linkerd-identity.linkerd.svc.cluster.local:8080
        - name: _pod_sa
          valueFrom:
            fieldRef:
              fieldPath: spec.serviceAccountName
        - name: _l5d_ns
          value: linkerd
        - name: _l5d_trustdomain
          value: cluster.local
        - name: LINKERD2_PROXY_IDENTITY_LOCAL_NAME
          value: $(_pod_sa).$(_pod_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        - name: LINKERD2_PROXY_IDENTITY_SVC_NAME
          value: linkerd-identity.$(_l5d_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        - name: LINKERD2_PROXY_DESTINATION_SVC_NAME
          value: linkerd-controller.$(_l5d_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        image: gcr.io/linkerd-io/proxy:dev-ad8f5985-x37y
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /metrics
            port: 4191
          initialDelaySeconds: 10
        name: linkerd-proxy
        ports:
        - containerPort: 4143
          name: linkerd-proxy
        - containerPort: 4191
          name: linkerd-admin
        readinessProbe:
          httpGet:
            path: /ready
            port: 4191
          initialDelaySeconds: 2
        resources: {}
        securityContext:
          runAsUser: 2102
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /var/run/linkerd/identity/end-entity
          name: linkerd-identity-end-entity
      serviceAccountName: linkerd-prometheus
      volumes:
      - emptyDir: {}
        name: data
      - configMap:
          name: linkerd-prometheus-config
        name: prometheus-config
      - emptyDir:
          medium: Memory
        name: linkerd-identity-end-entity
status: {}
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: linkerd-prometheus-config
  namespace: linkerd
  labels:
    linkerd.io/control-plane-component: prometheus
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
data:
  prometheus.yml: |-
    global:
      scrape_interval: 10s
      scrape_timeout: 10s
      evaluation_interval: 10s

    rule_files:
    - /etc/prometheus/*_rules.yml

    scrape_configs:
    - job_name: 'prometheus'
      static_configs:
      - targets: ['localhost:9090']

    - job_name: 'grafana'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names: ['linkerd']
      relabel_configs:
      - source_labels:
        - __meta_kubernetes_pod_container_name
        action: keep
        regex: ^grafana$

    - job_name: 'linkerd-controller'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names: ['linkerd']
      relabel_configs:
      - source_labels:
        - __meta_kubernetes_pod_label_linkerd_io_control_plane_component
        - __meta_kubernetes_pod_container_port_name
        action: keep
        regex: (.*);admin-http$
      - source_labels: [__meta_kubernetes_pod_container_name]
        action: replace
        target_label: component

    - job_name: 'linkerd-proxy'
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels:
        - __meta_kubernetes_pod_container_name
        - __meta_kubernetes_pod_container_port_name
        - __meta_kubernetes_pod_label_linkerd_io_control_plane_ns
        action: keep
        regex: ^linkerd-proxy;linkerd-admin;linkerd$
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: pod
      # special case k8s' "job" label, to not interfere with prometheus' "job"
      # label
      # __meta_kubernetes_pod_label_linkerd_io_proxy_job=foo =>
      # k8s_job=foo
      - source_labels: [__meta_kubernetes_pod_label_linkerd_io_proxy_job]
        action: replace
        target_label: k8s_job
      # drop __meta_kubernetes_pod_label_linkerd_io_proxy_job
      - action: labeldrop
        regex: __meta_kubernetes_pod_label_linkerd_io_proxy_job
      # __meta_kubernetes_pod_label_linkerd_io_proxy_deployment=foo =>
      # deployment=foo
      - action: labelmap
        regex: __meta_kubernetes_pod_label_linkerd_io_proxy_(.+)
      # drop all labels that we just made copies of in the previous labelmap
      - action: labeldrop
        regex: __meta_kubernetes_pod_label_linkerd_io_proxy_(.+)
      # __meta_kubernetes_pod_label_linkerd_io_foo=bar =>
      # foo=bar
      - action: labelmap
        regex: __meta_kubernetes_pod_label_linkerd_io_(.+)
---
###
### Grafana
###
---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: linkerd-grafana
  namespace: linkerd
---
kind: Service
apiVersion: v1
metadata:
  name: linkerd-grafana
  namespace: linkerd
  labels:
    linkerd.io/control-plane-component: grafana
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
spec:
  type: ClusterIP
  selector:
    linkerd.io/control-plane-component: grafana
  ports:
  - name: http
    port: 3000
    targetPort: 3000
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
  creationTimestamp: null
  labels:
    linkerd.io/control-plane-component: grafana
  name: linkerd-grafana
  namespace: linkerd
spec:
  replicas: 1
  strategy: {}
  template:
    metadata:
      annotations:
        linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
        linkerd.io/identity-mode: default
        linkerd.io/proxy-version: dev-ad8f5985-x37y
      creationTimestamp: null
      labels:
        linkerd.io/control-plane-component: grafana
        linkerd.io/control-plane-ns: linkerd
        linkerd.io/proxy-deployment: linkerd-grafana
    spec:
      containers:
      - env:
        - name: GF_PATHS_DATA
          value: /data
        image: gcr.io/linkerd-io/grafana:dev-ad8f5985-x37y
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 30
        name: grafana
        ports:
        - containerPort: 3000
          name: http
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000
        resources: {}
        securityContext:
          runAsUser: 472
        volumeMounts:
        - mountPath: /data
          name: data
        - mountPath: /etc/grafana
          name: grafana-config
          readOnly: true
      - env:
        - name: LINKERD2_PROXY_LOG
          value: warn,linkerd2_proxy=info
        - name: LINKERD2_PROXY_DESTINATION_SVC_ADDR
          value: linkerd-destination.linkerd.svc.cluster.local:8086
        - name: LINKERD2_PROXY_CONTROL_LISTEN_ADDR
          value: 0.0.0.0:4190
        - name: LINKERD2_PROXY_ADMIN_LISTEN_ADDR
          value: 0.0.0.0:4191
        - name: LINKERD2_PROXY_OUTBOUND_LISTEN_ADDR
          value: 127.0.0.1:4140
        - name: LINKERD2_PROXY_INBOUND_LISTEN_ADDR
          value: 0.0.0.0:4143
        - name: LINKERD2_PROXY_DESTINATION_PROFILE_SUFFIXES
          value: svc.cluster.local.
        - name: LINKERD2_PROXY_INBOUND_ACCEPT_KEEPALIVE
          value: 10000ms
        - name: LINKERD2_PROXY_OUTBOUND_CONNECT_KEEPALIVE
          value: 10000ms
        - name: _pod_ns
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: LINKERD2_PROXY_DESTINATION_CONTEXT
          value: ns:$(_pod_ns)
        - name: LINKERD2_PROXY_IDENTITY_DIR
          value: /var/run/linkerd/identity/end-entity
        - name: LINKERD2_PROXY_IDENTITY_TRUST_ANCHORS
          value: |
            -----BEGIN CERTIFICATE-----
            MIIDxjCCAq6gAwIBAgIJAO6DSG+Jvt0vMA0GCSqGSIb3DQEBDAUAMHAxCzAJBgNV
            BAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEOMAwGA1UECgwF
            VE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIwIAYJKoZIhvcNAQkBFhNUTUVTSEBub3Jk
            c3Ryb20uY29tMB4XDTE5MDMyODIxMTM0MFoXDTE5MDQyNzIxMTM0MFowcDELMAkG
            A1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQK
            DAVUTUVTSDEOMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5v
            cmRzdHJvbS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCeP6ez
            6jFDvmiK54pHhdH9/vwgteQ2SaPCCzH3+LPftE+98r9cYH7q+/AoHHaDUlK3CBRz
            63QrbKFNJfwY5LbEDKma+YR2zSMJLveDlW89hnuwVoCjdfThNqZOoqVOx1QFYBBv
            Z6lvtce2Oc5tmRwOfXudJTragqkMJme0Mn6CCy98R3VGysh7jnPJjb0JD2PygMMx
            KhGuzoM7Ib2Vf6vzOt4oqHFoHkCo1sgLvi7ojCo11ynB0pvequ6HElxgqEnoBUA7
            pIhsqe4/gJyC62xjBKON48G/7Ut0xgXMmN0Ir+7nfBiGC8iBVy6smSv+qQ3dAxGx
            UbAUwTKNge9p+1Y3AgMBAAGjYzBhMB0GA1UdDgQWBBSYj5Tn7VrJSXj02YbqGnUv
            ypxCGjAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8E
            BTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG9w0BAQwFAAOCAQEAcwQf730e
            6OhPRJ7yU5WVfARck3OgG1kWz4O3F0ZT9SC+85Q920jS3oBfaV2G4cTAsLgvk0rM
            62ghhN7BL/a06+iRkD7xO7w9ftcOReUqlaJ2SQi1L3eL6Cn6pu3mHwWyh3DqYdkW
            2y9SYGTWpmkIW/tG2k+/atnHeC7iEfxlO7Xq1aoAVBGJStR9JFQlETn52nRaG03r
            tMyEU+MrZhJDQR9gIFL/lBC/uLAkkNYqN7E4tbzc4n1rr1OuiTq3XeSdSGrxHkcp
            izHKiX1uPiG0iv5fI43XyTwHHlrfesYhxmFOv/I0HdsuFjQUHyPEq9pB0GsqKsoj
            L/EIQ1Caao5a3g==
            -----END CERTIFICATE-----
        - name: LINKERD2_PROXY_IDENTITY_TOKEN_FILE
          value: /var/run/secrets/kubernetes.io/serviceaccount/token
        - name: LINKERD2_PROXY_IDENTITY_SVC_ADDR
          value: linkerd-identity.linkerd.svc.cluster.local:8080
        - name: _pod_sa
          valueFrom:
            fieldRef:
              fieldPath: spec.serviceAccountName
        - name: _l5d_ns
          value: linkerd
        - name: _l5d_trustdomain
          value: cluster.local
        - name: LINKERD2_PROXY_IDENTITY_LOCAL_NAME
          value: $(_pod_sa).$(_pod_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        - name: LINKERD2_PROXY_IDENTITY_SVC_NAME
          value: linkerd-identity.$(_l5d_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        - name: LINKERD2_PROXY_DESTINATION_SVC_NAME
          value: linkerd-controller.$(_l5d_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        image: gcr.io/linkerd-io/proxy:dev-ad8f5985-x37y
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /metrics
            port: 4191
          initialDelaySeconds: 10
        name: linkerd-proxy
        ports:
        - containerPort: 4143
          name: linkerd-proxy
        - containerPort: 4191
          name: linkerd-admin
        readinessProbe:
          httpGet:
            path: /ready
            port: 4191
          initialDelaySeconds: 2
        resources: {}
        securityContext:
          runAsUser: 2102
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /var/run/linkerd/identity/end-entity
          name: linkerd-identity-end-entity
      serviceAccountName: linkerd-grafana
      volumes:
      - emptyDir: {}
        name: data
      - configMap:
          items:
          - key: grafana.ini
            path: grafana.ini
          - key: datasources.yaml
            path: provisioning/datasources/datasources.yaml
          - key: dashboards.yaml
            path: provisioning/dashboards/dashboards.yaml
          name: linkerd-grafana-config
        name: grafana-config
      - emptyDir:
          medium: Memory
        name: linkerd-identity-end-entity
status: {}
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: linkerd-grafana-config
  namespace: linkerd
  labels:
    linkerd.io/control-plane-component: grafana
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
data:
  grafana.ini: |-
    instance_name = linkerd-grafana

    [server]
    root_url = %(protocol)s://%(domain)s:/grafana/

    [auth]
    disable_login_form = true

    [auth.anonymous]
    enabled = true
    org_role = Editor

    [auth.basic]
    enabled = false

    [analytics]
    check_for_updates = false

  datasources.yaml: |-
    apiVersion: 1
    datasources:
    - name: prometheus
      type: prometheus
      access: proxy
      orgId: 1
      url: http://linkerd-prometheus.linkerd.svc.cluster.local:9090
      isDefault: true
      jsonData:
        timeInterval: "5s"
      version: 1
      editable: true

  dashboards.yaml: |-
    apiVersion: 1
    providers:
    - name: 'default'
      orgId: 1
      folder: ''
      type: file
      disableDeletion: true
      editable: true
      options:
        path: /var/lib/grafana/dashboards
        homeDashboardId: linkerd-top-line
---
###
### Service Profile Validator
###
---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: linkerd-sp-validator
  namespace: linkerd
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: linkerd-linkerd-sp-validator
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["list"]
- apiGroups: ["admissionregistration.k8s.io"]
  resources: ["validatingwebhookconfigurations"]
  verbs: ["create", "get", "delete"]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: linkerd-linkerd-sp-validator
subjects:
- kind: ServiceAccount
  name: linkerd-sp-validator
  namespace: linkerd
  apiGroup: ""
roleRef:
  kind: ClusterRole
  name: linkerd-linkerd-sp-validator
  apiGroup: rbac.authorization.k8s.io
---
kind: Service
apiVersion: v1
metadata:
  name: linkerd-sp-validator
  namespace: linkerd
  labels:
    linkerd.io/control-plane-component: sp-validator
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
spec:
  type: ClusterIP
  selector:
    linkerd.io/control-plane-component: sp-validator
  ports:
  - name: sp-validator
    port: 443
    targetPort: sp-validator
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  annotations:
    linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
  creationTimestamp: null
  labels:
    linkerd.io/control-plane-component: sp-validator
  name: linkerd-sp-validator
  namespace: linkerd
spec:
  replicas: 1
  selector:
    matchLabels:
      linkerd.io/control-plane-component: sp-validator
  strategy: {}
  template:
    metadata:
      annotations:
        linkerd.io/created-by: linkerd/cli dev-ad8f5985-x37y
        linkerd.io/identity-mode: default
        linkerd.io/proxy-version: dev-ad8f5985-x37y
      creationTimestamp: null
      labels:
        linkerd.io/control-plane-component: sp-validator
        linkerd.io/control-plane-ns: linkerd
        linkerd.io/proxy-deployment: linkerd-sp-validator
    spec:
      containers:
      - args:
        - sp-validator
        - -controller-namespace=linkerd
        - -log-level=info
        image: gcr.io/linkerd-io/controller:dev-ad8f5985-x37y
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /ping
            port: 9997
          initialDelaySeconds: 10
        name: sp-validator
        ports:
        - containerPort: 8443
          name: sp-validator
        readinessProbe:
          failureThreshold: 7
          httpGet:
            path: /ready
            port: 9997
        resources: {}
        securityContext:
          runAsUser: 2103
      - env:
        - name: LINKERD2_PROXY_LOG
          value: warn,linkerd2_proxy=info
        - name: LINKERD2_PROXY_DESTINATION_SVC_ADDR
          value: linkerd-destination.linkerd.svc.cluster.local:8086
        - name: LINKERD2_PROXY_CONTROL_LISTEN_ADDR
          value: 0.0.0.0:4190
        - name: LINKERD2_PROXY_ADMIN_LISTEN_ADDR
          value: 0.0.0.0:4191
        - name: LINKERD2_PROXY_OUTBOUND_LISTEN_ADDR
          value: 127.0.0.1:4140
        - name: LINKERD2_PROXY_INBOUND_LISTEN_ADDR
          value: 0.0.0.0:4143
        - name: LINKERD2_PROXY_DESTINATION_PROFILE_SUFFIXES
          value: svc.cluster.local.
        - name: LINKERD2_PROXY_INBOUND_ACCEPT_KEEPALIVE
          value: 10000ms
        - name: LINKERD2_PROXY_OUTBOUND_CONNECT_KEEPALIVE
          value: 10000ms
        - name: _pod_ns
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: LINKERD2_PROXY_DESTINATION_CONTEXT
          value: ns:$(_pod_ns)
        - name: LINKERD2_PROXY_IDENTITY_DIR
          value: /var/run/linkerd/identity/end-entity
        - name: LINKERD2_PROXY_IDENTITY_TRUST_ANCHORS
          value: |
            -----BEGIN CERTIFICATE-----
            MIIDxjCCAq6gAwIBAgIJAO6DSG+Jvt0vMA0GCSqGSIb3DQEBDAUAMHAxCzAJBgNV
            BAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEOMAwGA1UECgwF
            VE1FU0gxDjAMBgNVBAsMBVRNRVNIMSIwIAYJKoZIhvcNAQkBFhNUTUVTSEBub3Jk
            c3Ryb20uY29tMB4XDTE5MDMyODIxMTM0MFoXDTE5MDQyNzIxMTM0MFowcDELMAkG
            A1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0dGxlMQ4wDAYDVQQK
            DAVUTUVTSDEOMAwGA1UECwwFVE1FU0gxIjAgBgkqhkiG9w0BCQEWE1RNRVNIQG5v
            cmRzdHJvbS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCeP6ez
            6jFDvmiK54pHhdH9/vwgteQ2SaPCCzH3+LPftE+98r9cYH7q+/AoHHaDUlK3CBRz
            63QrbKFNJfwY5LbEDKma+YR2zSMJLveDlW89hnuwVoCjdfThNqZOoqVOx1QFYBBv
            Z6lvtce2Oc5tmRwOfXudJTragqkMJme0Mn6CCy98R3VGysh7jnPJjb0JD2PygMMx
            KhGuzoM7Ib2Vf6vzOt4oqHFoHkCo1sgLvi7ojCo11ynB0pvequ6HElxgqEnoBUA7
            pIhsqe4/gJyC62xjBKON48G/7Ut0xgXMmN0Ir+7nfBiGC8iBVy6smSv+qQ3dAxGx
            UbAUwTKNge9p+1Y3AgMBAAGjYzBhMB0GA1UdDgQWBBSYj5Tn7VrJSXj02YbqGnUv
            ypxCGjAfBgNVHSMEGDAWgBSYj5Tn7VrJSXj02YbqGnUvypxCGjAPBgNVHRMBAf8E
            BTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG9w0BAQwFAAOCAQEAcwQf730e
            6OhPRJ7yU5WVfARck3OgG1kWz4O3F0ZT9SC+85Q920jS3oBfaV2G4cTAsLgvk0rM
            62ghhN7BL/a06+iRkD7xO7w9ftcOReUqlaJ2SQi1L3eL6Cn6pu3mHwWyh3DqYdkW
            2y9SYGTWpmkIW/tG2k+/atnHeC7iEfxlO7Xq1aoAVBGJStR9JFQlETn52nRaG03r
            tMyEU+MrZhJDQR9gIFL/lBC/uLAkkNYqN7E4tbzc4n1rr1OuiTq3XeSdSGrxHkcp
            izHKiX1uPiG0iv5fI43XyTwHHlrfesYhxmFOv/I0HdsuFjQUHyPEq9pB0GsqKsoj
            L/EIQ1Caao5a3g==
            -----END CERTIFICATE-----
        - name: LINKERD2_PROXY_IDENTITY_TOKEN_FILE
          value: /var/run/secrets/kubernetes.io/serviceaccount/token
        - name: LINKERD2_PROXY_IDENTITY_SVC_ADDR
          value: linkerd-identity.linkerd.svc.cluster.local:8080
        - name: _pod_sa
          valueFrom:
            fieldRef:
              fieldPath: spec.serviceAccountName
        - name: _l5d_ns
          value: linkerd
        - name: _l5d_trustdomain
          value: cluster.local
        - name: LINKERD2_PROXY_IDENTITY_LOCAL_NAME
          value: $(_pod_sa).$(_pod_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        - name: LINKERD2_PROXY_IDENTITY_SVC_NAME
          value: linkerd-identity.$(_l5d_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        - name: LINKERD2_PROXY_DESTINATION_SVC_NAME
          value: linkerd-controller.$(_l5d_ns).serviceaccount.identity.$(_l5d_ns).$(_l5d_trustdomain)
        image: gcr.io/linkerd-io/proxy:dev-ad8f5985-x37y
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /metrics
            port: 4191
          initialDelaySeconds: 10
        name: linkerd-proxy
        ports:
        - containerPort: 4143
          name: linkerd-proxy
        - containerPort: 4191
          name: linkerd-admin
        readinessProbe:
          httpGet:
            path: /ready
            port: 4191
          initialDelaySeconds: 2
        resources: {}
        securityContext:
          runAsUser: 2102
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /var/run/linkerd/identity/end-entity
          name: linkerd-identity-end-entity
      serviceAccountName: linkerd-sp-validator
      volumes:
      - configMap:
          name: linkerd-config
        name: config
      - emptyDir:
          medium: Memory
        name: linkerd-identity-end-entity
status: {}
---
